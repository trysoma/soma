# Example workflow for creating releases with changie-release
# This workflow runs when VERSION or CHANGELOG.md files are updated (typically after changelog PR is merged)

name: Create Release

on:
  push:
    branches: [main]
    paths:
      - 'VERSION'
      - 'CHANGELOG.md'
  workflow_dispatch:

permissions:
  contents: write  # Required for creating releases and tags
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.release.outputs.version }}
      release-url: ${{ steps.release.outputs.release-url }}
      skipped: ${{ steps.release.outputs.skipped }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history needed for release notes
          token: ${{ secrets.TRY_SOMA_BOT_TOKEN }}  # Use bot PAT for pushing tags

      - name: Create release
        id: release
        uses: trysoma/github-actions/changie-release@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          bot-token: ${{ secrets.TRY_SOMA_BOT_TOKEN }}


      - name: Print release info
        if: steps.release.outputs.skipped != 'true'
        run: |
          echo "âœ… Release created successfully!"
          echo "Version: ${{ steps.release.outputs.version }}"
          echo "URL: ${{ steps.release.outputs.release-url }}"

      - name: Print skip message
        if: steps.release.outputs.skipped == 'true'
        run: |
          echo "â­ï¸ Release skipped - tag already exists"

  build-binaries:
    name: Build Soma binaries
    needs: release
    if: needs.release.outputs.skipped != 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: soma
            asset_name: soma-linux-x86_64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact_name: soma
            asset_name: soma-linux-aarch64
            use_cross: true
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: soma
            asset_name: soma-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: soma
            asset_name: soma-macos-aarch64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: soma.exe
            asset_name: soma-windows-x86_64.exe
    env:
      CARGO_INCREMENTAL: 0
      CARGO_PROFILE_TEST_DEBUG: 0
      CARGO_PROFILE_RELEASE_LTO: true
      CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 1
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          target: ${{ matrix.target }}
          components: ''
          cache: 'false'

      - name: Install cross
        if: matrix.use_cross
        uses: taiki-e/install-action@v2
        with:
          tool: cross
      
      - name: Setup pnpm and Node.js (for frontend build)
        uses: ./.github/actions/setup-pnpm-node
        with:
          install-dependencies: 'true'

      - name: Build frontend
        run: |
          cd crates/soma/app
          pnpm run build
        shell: bash

      - name: Build binary
        run: |
          if [ "${{ matrix.use_cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }} --bin soma --locked
          else
            cargo build --release --target ${{ matrix.target }} --bin soma --locked
          fi
        shell: bash

      - name: Strip binary (Unix)
        if: matrix.os != 'windows-latest'
        run: strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

      - name: Upload binary to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.release.outputs.release-url }}
          asset_path: target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
          asset_name: ${{ matrix.asset_name }}
          asset_content_type: application/octet-stream

  publish-npm:
    name: Publish to npm
    needs: release
    if: needs.release.outputs.skipped != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for npm provenance
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: upgrade npm to 11 (supports trusted publishing)
        run: |
          sudo npm install -g npm@latest
          npm -v

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup Rust (for sdk-core build)
        uses: ./.github/actions/setup-rust
        with:
          components: ''

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm -r run build

      - name: Publish packages
        run: pnpm -r publish --access public --no-git-checks

      - name: Comment npm package links on release
        uses: actions/github-script@v7
        env:
          RELEASE_TAG: ${{ needs.release.outputs.version }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = process.env.RELEASE_TAG;

            // Get all published packages from workspace
            const packages = [
              '@trysoma/sdk',
              '@trysoma/sdk-core',
              '@trysoma/api-client'
            ];

            // Create links to npm packages
            const packageLinks = packages.map(pkg => {
              const pkgName = pkg.replace('@trysoma/', '');
              return `- [${pkg}](https://www.npmjs.com/package/${pkg}/v/${tag.replace('v', '')})`;
            }).join('\n');

            const comment = `## ðŸ“¦ Published NPM Packages

            ${packageLinks}

            Install with:
            \`\`\`bash
            pnpm add ${packages.join(' ')}
            \`\`\`
            `;

            // Find the release by tag
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: tag
            });

            // Update the release body
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              body: (release.body || '') + '\n\n' + comment
            });
