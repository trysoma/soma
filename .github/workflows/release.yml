name: Create Release

on:
  push:
    branches: [main]
    paths:
      - 'VERSION'
      - 'CHANGELOG.md'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  prepare-release:
    uses: ./.github/workflows/common-prepare-release.yml
    with:
      release-type: regular
    secrets:
      TRY_SOMA_BOT_TOKEN: ${{ secrets.TRY_SOMA_BOT_TOKEN }}

  create-artifacts:
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.TRY_SOMA_BOT_TOKEN }}

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          components: ''
          install-protoc: 'false'

      - name: Update Cargo.lock
        run: |
          echo "Updating Cargo.lock for version ${{ needs.prepare-release.outputs.version }}"
          cargo update --workspace

      - name: Create release artifact
        run: |
          # Capture all modified files (including any Cargo.toml version changes)
          # Use git status to find all modified/new files
          git add -A

          # Create tarball of all changes using --files-from to handle special characters
          git diff --cached --name-only --diff-filter=ACMR > /tmp/changed-files.txt

          # Also add the frontend dist directory (not tracked by git)
          if [ -d "crates/soma/app/dist" ]; then
            echo "Adding frontend dist directory to artifact"
            find crates/soma/app/dist -type f >> /tmp/changed-files.txt
          fi

          if [ -s /tmp/changed-files.txt ]; then
            echo "Packaging changed files:"
            cat /tmp/changed-files.txt
            tar -czf release-changes.tar.gz --files-from=/tmp/changed-files.txt
          else
            echo "No changes detected, creating empty tarball"
            tar -czf release-changes.tar.gz --files-from /dev/null
          fi

      - name: Upload release changes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-changes
          path: release-changes.tar.gz
          retention-days: 1

  build-core-js-sdk:
    needs: [prepare-release, create-artifacts]
    uses: ./.github/workflows/common-build-core-js-sdk.yml
    with:
      revision: ${{ github.ref }}

  test-sdk-js-macOS-windows-binding:
    needs: build-core-js-sdk
    uses: ./.github/workflows/common-test-sdk-js-macOS-windows-binding.yml

  test-linux-js-sdk-binding:
    needs: build-core-js-sdk
    uses: ./.github/workflows/common-test-linux-js-sdk-binding.yml

  build-soma:
    needs: [prepare-release, create-artifacts]
    uses: ./.github/workflows/common-build-soma.yml
    with:
      revision: ${{ github.ref }}
    secrets:
      AWS_INTEGRATION_TESTS_ROLE_ARN: ${{ secrets.AWS_INTEGRATION_TESTS_ROLE_ARN }}

  test-soma-macOS-windows:
    needs: build-soma
    uses: ./.github/workflows/common-test-soma-macOS-windows.yml
    with:
      revision: ${{ github.ref }}
    secrets:
      AWS_INTEGRATION_TESTS_ROLE_ARN: ${{ secrets.AWS_INTEGRATION_TESTS_ROLE_ARN }}

  test-soma-linux:
    needs: build-soma
    uses: ./.github/workflows/common-test-soma-linux.yml
    with:
      revision: ${{ github.ref }}
    secrets:
      AWS_INTEGRATION_TESTS_ROLE_ARN: ${{ secrets.AWS_INTEGRATION_TESTS_ROLE_ARN }}

  publish-npm:
    needs:
      - prepare-release
      - build-core-js-sdk
      - build-soma
      - test-sdk-js-macOS-windows-binding
      - test-linux-js-sdk-binding
      - test-soma-macOS-windows
      - test-soma-linux
    uses: ./.github/workflows/common-publish-npm.yml
    with:
      version: ${{ needs.prepare-release.outputs.version }}
      npm-tag: latest
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  create-github-release:
    needs: [prepare-release, build-soma, build-core-js-sdk, publish-npm]
    uses: ./.github/workflows/common-create-github-release.yml
    with:
      version: ${{ needs.prepare-release.outputs.version }}
      revision: ${{ github.ref }}
      prerelease: false
    secrets:
      TRY_SOMA_BOT_TOKEN: ${{ secrets.TRY_SOMA_BOT_TOKEN }}

  create-github-issue-on-fail:
    needs:
      - prepare-release
      - build-soma
      - build-core-js-sdk
      # - test-sdk-js-macOS-windows-binding
      # - test-linux-js-sdk-binding
      # - test-soma-macOS-windows
      # - test-soma-linux
      - publish-npm
      - create-github-release
    if: failure()
    permissions:
      issues: write
    uses: ./.github/workflows/common-create-github-issue-on-fail.yml
    with:
      version: ${{ needs.prepare-release.outputs.version }}
      workflow-type: release
      failed-jobs: ${{ needs.prepare-release.result == 'failure' && 'prepare-release' || '' }}${{ needs.build-soma.result == 'failure' && format(',build-soma') || '' }}${{ needs.build-core-js-sdk.result == 'failure' && format(',build-core-js-sdk') || '' }}${{ needs.publish-npm.result == 'failure' && format(',publish-npm') || '' }}${{ needs.create-github-release.result == 'failure' && format(',create-github-release') || '' }}
