name: PR Checks

on:
  - pull_request
permissions:
  pull-requests: write
  contents: read
  id-token: write

jobs:
  db-quality:
    name: Database quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Fetch main branch
        run: |
          git fetch origin main
          git branch main origin/main 2>/dev/null || git checkout -b main origin/main 2>/dev/null || true

      - name: Install Atlas CLI
        run: |
          curl -sSf https://atlasgo.sh | sh -s -- --community -y
          echo "$HOME/.atlas/bin" >> $GITHUB_PATH

      - name: Validate Soma database migrations for breaking changes
        id: lint-soma
        if: always()
        run: |
          lint_output=$(atlas migrate lint --env soma --git-base main 2>&1) || lint_exit=$?
          if [ -z "$lint_output" ]; then
            lint_output="SUCCESS: checksums match, no breaking changes"
          fi
          echo "lint_output<<EOF" >> $GITHUB_OUTPUT
          echo "$lint_output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          if [ -n "${lint_exit:-}" ]; then
            echo "$lint_output"
            exit $lint_exit
          fi

      - name: Comment Soma database migration lint results on PR
        uses: thollander/actions-comment-pull-request@v3
        if: always()
        with:
          mode: upsert
          comment-tag: soma-db-quality
          message: |
            Soma Database Migration Lint Report:
            ```
            ${{ steps.lint-soma.outputs.lint_output }}
            ```

      - name: Validate Bridge database migrations for breaking changes
        id: lint-bridge
        if: always()
        run: |
          lint_output=$(atlas migrate lint --env bridge --git-base main 2>&1) || lint_exit=$?
          if [ -z "$lint_output" ]; then
            lint_output="SUCCESS: checksums match, no breaking changes"
          fi
          echo "lint_output<<EOF" >> $GITHUB_OUTPUT
          echo "$lint_output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          if [ -n "${lint_exit:-}" ]; then
            echo "$lint_output"
            exit $lint_exit
          fi

      - name: Comment Bridge database migration lint results on PR
        uses: thollander/actions-comment-pull-request@v3
        if: always()
        with:
          mode: upsert
          comment-tag: bridge-db-quality
          message: |
            Bridge Database Migration Lint Report:
            ```
            ${{ steps.lint-bridge.outputs.lint_output }}
            ```

  api-quality:
    name: API quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Download OpenAPI spec from main via API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3.raw" \
                -o ./openapi-main.json \
                https://api.github.com/repos/${{ github.repository }}/contents/openapi.json?ref=main

      - name: Setup OpenAPI Spec diff action
        uses: oasdiff/oasdiff-action/diff@main
        id: diff
        with:
          base: ./openapi-main.json
          revision: ./openapi.json

      - name: Running OpenAPI Spec diff action
        uses: thollander/actions-comment-pull-request@v3
        with:
          mode: upsert
          comment-tag: api-quality
          message: |
            OpenAPI Spec diff report:
            ```
            ${{ steps.diff.outputs.diff }}
            ```

      - name: Running OpenAPI Spec breaking changes check
        id: breaking
        uses: oasdiff/oasdiff-action/breaking@main
        with:
          base: ./openapi-main.json
          revision: ./openapi.json
          fail-on: ERR

      - name: Comment Breaking changes on PR
        uses: thollander/actions-comment-pull-request@v3
        if: always()
        with:
          mode: upsert
          comment-tag: api-spec-diff
          message: |
            OpenAPI Spec Breaking changes report:
            ```
            ${{ steps.breaking.outputs.breaking }}
            ```

      # TODO: add API changelog generation action at some point
        
  rust-quality:
    name: Rust quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      # Disable incremental compilation for faster from-scratch builds
      CARGO_INCREMENTAL: 0
      CARGO_PROFILE_TEST_DEBUG: 0
      CARGO_PROFILE_RELEASE_LTO: true
      CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Configure AWS Credentials for integration tests
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          audience: sts.amazonaws.com
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.AWS_INTEGRATION_TESTS_ROLE_ARN }}

      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: 1.88.0
          profile: minimal
          components: rustfmt,clippy

      - uses: Swatinem/rust-cache@v2

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install cargo-llvm-cov and cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov,cargo-nextest

      - name: Run cargo clippy
        run: cargo clippy --all-targets --all-features --locked -- -D warnings

      - name: Run cargo fmt
        run: cargo fmt --all -- --check

      - name: Run cargo nextest with coverage
        run: |
          mkdir -p .coverage-tmp
          cargo llvm-cov nextest --all-features --workspace --locked --lcov --output-path .coverage-tmp/rust.lcov

      - name: Upload Rust coverage LCOV
        uses: actions/upload-artifact@v4
        with:
          name: rust-coverage-lcov
          path: .coverage-tmp/rust.lcov
          retention-days: 7
          if-no-files-found: error

  ts-quality:
    name: TypeScript quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm lint:ci
        run: |
          set -e
          pnpm -r --workspace-concurrency=1  run lint:ci

      - name: Run tests with coverage
        run: |
          mkdir -p .coverage-tmp
          pnpm -r --workspace-concurrency=1 --filter './js/packages/*' --filter './crates/sdk-js' run test:coverage

      - name: Collect JS coverage reports
        if: always()
        run: |
          echo "=== Searching for lcov.info files ==="
          find . -name 'lcov.info' -type f -not -path './coverage/*' -not -path './node_modules/*' -not -path './js/examples/*' || echo "No lcov.info files found"

          echo ""
          echo "=== Collecting coverage files ==="
          mkdir -p .coverage-tmp
          count=0

          # Use process substitution instead of pipe to avoid subshell
          while IFS= read -r file; do
            dir=$(dirname "$file")
            pkgdir=$(dirname "$dir")
            name=$(echo "$pkgdir" | sed 's/^\.\///' | sed 's/\//-/g')
            output_file=".coverage-tmp/js-$name.lcov"
            echo "‚úì Processing: $file -> $output_file"

            # Adjust paths in the lcov file to be relative to repo root
            sed "s|^SF:|SF:$pkgdir/|g" "$file" > "$output_file"
            count=$((count + 1))
          done < <(find . -name 'lcov.info' -type f -not -path './coverage/*' -not -path './node_modules/*' -not -path './js/examples/*')

          echo ""
          if [ "$count" -eq 0 ]; then
            echo "‚ùå ERROR: No coverage files found!"
            echo "Expected to find lcov.info files in JS packages but none were generated."
            exit 1
          else
            echo "‚úì Successfully collected $count coverage file(s)"
          fi

          echo ""
          echo "=== Coverage files in .coverage-tmp ==="
          ls -la .coverage-tmp/

      - name: Debug coverage directory
        run: |
          echo "Current directory: $(pwd)"
          echo "Contents of .coverage-tmp:"
          ls -la .coverage-tmp/ || echo "Directory doesn't exist"
          echo "Finding lcov files:"
          find .coverage-tmp -name "*.lcov" -type f || echo "No lcov files found"

      - name: Upload JS coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: js-coverage-lcov
          path: .coverage-tmp/
          retention-days: 7
          if-no-files-found: error
          include-hidden-files: true

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [rust-quality, ts-quality]
    permissions:
      contents: read
      pull-requests: write
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Fetch main branch
        run: |
          git fetch origin main:main || git fetch origin main

      - name: Download Rust coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: rust-coverage-lcov
          path: ./coverage/rust/

      - name: Download JS coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: js-coverage-lcov
          path: ./coverage/js/

      - name: Setup Node.js for lcov-merger
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install lcov tools
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov bc
          npm install -g lcov-result-merger

      - name: Merge coverage reports
        id: merge-coverage
        run: |
          mkdir -p ./coverage/merged

          # Debug: Show what was downloaded
          echo "=== Downloaded artifacts structure ==="
          ls -laR ./coverage/ || echo "No coverage directory found"

          # Collect all LCOV files
          lcov_files=""
          if [ -f ./coverage/rust/rust.lcov ]; then
            echo "‚úì Found Rust coverage: ./coverage/rust/rust.lcov"
            lcov_files="$lcov_files ./coverage/rust/rust.lcov"
          else
            echo "‚úó Rust coverage not found at ./coverage/rust/rust.lcov"
          fi

          # Add all JS coverage files
          if [ -d ./coverage/js ]; then
            echo "‚úì JS coverage directory exists"
            for file in ./coverage/js/js-*.lcov; do
              if [ -f "$file" ]; then
                echo "‚úì Found JS coverage: $file"
                lcov_files="$lcov_files $file"
              fi
            done

            # Check for .no-coverage marker
            if [ -f ./coverage/js/.no-coverage ]; then
              echo "‚ö† Found .no-coverage marker - no JS coverage was generated"
            fi
          else
            echo "‚úó JS coverage directory not found at ./coverage/js"
          fi

          # Merge LCOV files
          if [ -n "$lcov_files" ]; then
            echo "=== Merging coverage files: $lcov_files ==="
            npx lcov-result-merger $lcov_files ./coverage/merged/coverage.lcov
            echo "‚úì Coverage merge completed"
          else
            echo "‚ùå ERROR: No coverage files found to merge!"
            echo "Expected to find coverage files from Rust and JS jobs but none were found."
            exit 1
          fi

          # Parse coverage metrics from merged LCOV
          coverage_summary=$(lcov --summary ./coverage/merged/coverage.lcov 2>&1 | grep -E "lines|functions|branches" | head -3)
          echo "coverage_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$coverage_summary" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Extract percentages
          lines_coverage=$(echo "$coverage_summary" | grep "lines" | grep -oE "[0-9]+\.[0-9]+%" | head -1 | sed 's/%//' || echo "0")
          functions_coverage=$(echo "$coverage_summary" | grep "functions" | grep -oE "[0-9]+\.[0-9]+%" | head -1 | sed 's/%//' || echo "0")
          branches_coverage=$(echo "$coverage_summary" | grep "branches" | grep -oE "[0-9]+\.[0-9]+%" | head -1 | sed 's/%//' || echo "0")

          echo "lines_coverage=$lines_coverage" >> $GITHUB_OUTPUT
          echo "functions_coverage=$functions_coverage" >> $GITHUB_OUTPUT
          echo "branches_coverage=$branches_coverage" >> $GITHUB_OUTPUT

      - name: Get latest main branch workflow run
        id: get-main-run
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the latest successful workflow run on main branch
          latest_run=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/workflows/main-coverage.yml/runs?branch=main&status=success&per_page=1" \
            --jq '.workflow_runs[0].id' 2>/dev/null || echo "")

          if [ -z "$latest_run" ] || [ "$latest_run" = "null" ]; then
            echo "‚ö† No successful main coverage workflow run found (workflow may not exist yet)"
            echo "run_id=" >> $GITHUB_OUTPUT
          else
            echo "‚úì Found latest main coverage run: $latest_run"
            echo "run_id=$latest_run" >> $GITHUB_OUTPUT
          fi

      - name: Download main branch coverage metrics
        if: steps.get-main-run.outputs.run_id != ''
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p .coverage-main

          # Download the artifact from the main branch run
          gh run download ${{ steps.get-main-run.outputs.run_id }} \
            --name main-coverage-metrics \
            --dir .coverage-main

          if [ -f .coverage-main/main-coverage.json ]; then
            echo "‚úì Successfully downloaded main branch coverage metrics"
            cat .coverage-main/main-coverage.json
          else
            echo "‚ö† Failed to download coverage metrics"
          fi

      - name: Get coverage from main branch
        id: main-coverage
        run: |
          if [ -f .coverage-main/main-coverage.json ]; then
            echo "‚úì Found coverage metrics from main branch"
            cat .coverage-main/main-coverage.json

            main_lines=$(jq -r '.lines' .coverage-main/main-coverage.json)
            main_functions=$(jq -r '.functions' .coverage-main/main-coverage.json)
            main_branches=$(jq -r '.branches' .coverage-main/main-coverage.json)

            echo "main_lines=$main_lines" >> $GITHUB_OUTPUT
            echo "main_functions=$main_functions" >> $GITHUB_OUTPUT
            echo "main_branches=$main_branches" >> $GITHUB_OUTPUT
          else
            echo "‚ö† No coverage metrics found from main branch"
            echo "main_lines=" >> $GITHUB_OUTPUT
            echo "main_functions=" >> $GITHUB_OUTPUT
            echo "main_branches=" >> $GITHUB_OUTPUT
          fi

      - name: Calculate coverage changes
        id: coverage-diff
        run: |
          current_lines="${{ steps.merge-coverage.outputs.lines_coverage }}"
          current_functions="${{ steps.merge-coverage.outputs.functions_coverage }}"
          current_branches="${{ steps.merge-coverage.outputs.branches_coverage }}"

          main_lines="${{ steps.main-coverage.outputs.main_lines }}"
          main_functions="${{ steps.main-coverage.outputs.main_functions }}"
          main_branches="${{ steps.main-coverage.outputs.main_branches }}"

          # Function to calculate and format diff
          calculate_diff() {
            local current=$1
            local main=$2

            # Check if main coverage exists and is valid
            if [ -z "$main" ] || [ "$main" = "null" ] || [ "$main" = "0" ]; then
              echo "N/A"
              return
            fi

            # Calculate diff
            local diff=$(echo "scale=2; $current - $main" | bc)

            # Format with + sign for positive values
            if (( $(echo "$diff > 0" | bc -l) )); then
              echo "+${diff}%"
            elif (( $(echo "$diff < 0" | bc -l) )); then
              echo "${diff}%"
            else
              echo "0%"
            fi
          }

          lines_diff_formatted=$(calculate_diff "$current_lines" "$main_lines")
          functions_diff_formatted=$(calculate_diff "$current_functions" "$main_functions")
          branches_diff_formatted=$(calculate_diff "$current_branches" "$main_branches")

          echo "lines_diff=$lines_diff_formatted" >> $GITHUB_OUTPUT
          echo "functions_diff=$functions_diff_formatted" >> $GITHUB_OUTPUT
          echo "branches_diff=$branches_diff_formatted" >> $GITHUB_OUTPUT

      - name: Generate HTML coverage report
        if: always()
        run: |
          if [ -f ./coverage/merged/coverage.lcov ] && [ -s ./coverage/merged/coverage.lcov ]; then
            if grep -q "^SF:" ./coverage/merged/coverage.lcov; then
              mkdir -p ./coverage/html
              genhtml ./coverage/merged/coverage.lcov --output-directory ./coverage/html --ignore-errors source --prefix $(pwd)
              echo "‚úì HTML report generated at ./coverage/html/index.html"
            else
              echo "‚ö† Coverage file exists but contains no valid coverage records"
            fi
          else
            echo "‚ö† No coverage data available for HTML report generation"
          fi

      - name: Upload merged coverage HTML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: merged-coverage-html
          path: ./coverage/html/
          retention-days: 7

      - name: Upload merged coverage LCOV
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: merged-coverage-lcov
          path: ./coverage/merged/coverage.lcov
          retention-days: 7

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        if: always()
        with:
          files: ./coverage/merged/coverage.lcov
          fail_ci_if_error: false
          verbose: true
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Comment coverage report on PR (no main baseline)
        uses: thollander/actions-comment-pull-request@v3
        if: always() && steps.main-coverage.outputs.main_lines == ''
        with:
          mode: upsert
          comment-tag: coverage
          message: |
            ## üìä Coverage Report

            ### Overall Coverage Metrics

            | Metric | Current |
            |--------|---------|
            | **Lines** | ${{ steps.merge-coverage.outputs.lines_coverage }}% |
            | **Functions** | ${{ steps.merge-coverage.outputs.functions_coverage }}% |
            | **Branches** | ${{ steps.merge-coverage.outputs.branches_coverage }}% |

            > ‚ÑπÔ∏è No baseline coverage found from main branch yet. Coverage comparison will be available once the main branch workflow completes.

            ### Coverage Details
            ```
            ${{ steps.merge-coverage.outputs.coverage_summary }}
            ```

            ### üìÅ Coverage Reports

            Download the HTML coverage reports from the workflow artifacts:
            - [View Coverage Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Rust Coverage: `rust-coverage-lcov` artifact
            - JS Coverage: `js-coverage-lcov` artifact
            - Merged Coverage HTML: `merged-coverage-html` artifact
            - Merged Coverage LCOV: `merged-coverage-lcov` artifact

            Coverage has also been uploaded to [Codecov](https://codecov.io/gh/${{ github.repository }})

      - name: Comment coverage report on PR (with comparison)
        uses: thollander/actions-comment-pull-request@v3
        if: always() && steps.main-coverage.outputs.main_lines != ''
        with:
          mode: upsert
          comment-tag: coverage
          message: |
            ## üìä Coverage Report

            ### Overall Coverage Metrics

            | Metric | Current | Change |
            |--------|---------|--------|
            | **Lines** | ${{ steps.merge-coverage.outputs.lines_coverage }}% | ${{ steps.coverage-diff.outputs.lines_diff }} |
            | **Functions** | ${{ steps.merge-coverage.outputs.functions_coverage }}% | ${{ steps.coverage-diff.outputs.functions_diff }} |
            | **Branches** | ${{ steps.merge-coverage.outputs.branches_coverage }}% | ${{ steps.coverage-diff.outputs.branches_diff }} |

            ### Coverage Details
            ```
            ${{ steps.merge-coverage.outputs.coverage_summary }}
            ```

            ### üìÅ Coverage Reports

            Download the HTML coverage reports from the workflow artifacts:
            - [View Coverage Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Rust Coverage: `rust-coverage-lcov` artifact
            - JS Coverage: `js-coverage-lcov` artifact
            - Merged Coverage HTML: `merged-coverage-html` artifact
            - Merged Coverage LCOV: `merged-coverage-lcov` artifact

            Coverage has also been uploaded to [Codecov](https://codecov.io/gh/${{ github.repository }})
