name: PR Checks

on:
  - pull_request
permissions:
  pull-requests: write
  contents: read
  id-token: write

jobs:
  db-quality:
    name: Database quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Fetch main branch
        run: |
          git fetch origin main
          git branch main origin/main 2>/dev/null || git checkout -b main origin/main 2>/dev/null || true

      - name: Install Atlas CLI
        run: |
          curl -sSf https://atlasgo.sh | sh -s -- --community -y
          echo "$HOME/.atlas/bin" >> $GITHUB_PATH

      - name: Validate Soma database migrations
        uses: ./.github/actions/atlas-migrate-lint
        with:
          env: soma
          git-base: main
          comment-tag: soma-db-quality
          display-name: Soma Database

      - name: Validate Mcp database migrations
        uses: ./.github/actions/atlas-migrate-lint
        with:
          env: mcp 
          git-base: main
          comment-tag: mcp-db-quality
          display-name: Mcp Database
      
      - name: Validate Encryption database migrations
        uses: ./.github/actions/atlas-migrate-lint
        with:
          env: encryption
          git-base: main
          comment-tag: encryption-db-quality
          display-name: Encryption Database

      - name: Validate Identity database migrations
        uses: ./.github/actions/atlas-migrate-lint
        with:
          env: identity
          git-base: main
          comment-tag: identity-db-quality
          display-name: Identity Database

      - name: Validate Environment database migrations
        uses: ./.github/actions/atlas-migrate-lint
        with:
          env: environment
          git-base: main
          comment-tag: environment-db-quality
          display-name: Environment Database

  api-quality:
    name: API quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Download OpenAPI spec from main via API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3.raw" \
                -o ./openapi-main.json \
                https://api.github.com/repos/${{ github.repository }}/contents/openapi.json?ref=main

      - name: Running OpenAPI Spec diff check
        uses: oasdiff/oasdiff-action/diff@main
        id: diff
        with:
          base: ./openapi-main.json
          revision: ./openapi.json

      - name: Comment OpenAPI Spec diff on PR
        uses: thollander/actions-comment-pull-request@v3
        with:
          mode: upsert
          comment-tag: api-quality
          message: |
            OpenAPI Spec diff report:
            ```
            ${{ steps.diff.outputs.diff }}
            ```

      - name: Running OpenAPI Spec breaking changes check
        id: breaking
        uses: oasdiff/oasdiff-action/breaking@main
        with:
          base: ./openapi-main.json
          revision: ./openapi.json
          fail-on: ERR

      - name: Comment Breaking changes on PR
        uses: thollander/actions-comment-pull-request@v3
        if: always()
        with:
          mode: upsert
          comment-tag: api-spec-diff
          message: |
            OpenAPI Spec Breaking changes report:
            ```
            ${{ steps.breaking.outputs.breaking }}
            ```

      # TODO: add API changelog generation action at some point
        
  rust-quality:
    name: Rust quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      # Disable incremental compilation for faster from-scratch builds
      CARGO_INCREMENTAL: 0
      CARGO_PROFILE_TEST_DEBUG: 0
      CARGO_PROFILE_RELEASE_LTO: true
      CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 1
      # Reduce disk usage by limiting target directory size
      CARGO_PROFILE_DEV_DEBUG: 0
      CARGO_PROFILE_DEV_OPT_LEVEL: 0
      # Use sparse registry to reduce disk usage
      CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
      # Limit number of build jobs to reduce memory/disk usage
      CARGO_BUILD_JOBS: 2
      # SQLite optimizations to reduce temp file creation during tests
      SQLITE_TMPDIR: /tmp
      TMPDIR: /tmp
    steps:
      - name: Free disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          # Remove large unused tools to free disk space (can free 20-30GB)
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/share/az*
          echo "Disk space after cleanup:"
          df -h

      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Configure AWS Credentials for integration tests
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          audience: sts.amazonaws.com
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.AWS_INTEGRATION_TESTS_ROLE_ARN }}

      - name: Start Dex (OIDC/OAuth2 provider) for integration tests
        uses: ./.github/actions/setup-docker-compose
        with:
          compose-file: ./test/docker-compose.yml
          health-check-url: http://localhost:5556/dex/keys

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          install-protoc: 'true'
          components: 'rustfmt,clippy'
          cache: 'true'

      - name: Install cargo-llvm-cov and cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov,cargo-nextest

      - name: Check disk space after setup
        run: |
          echo "Disk space after Rust setup:"
          df -h
          echo "Checking for existing temp files:"
          find /tmp -name "*.db*" -o -name "*sqlite*" 2>/dev/null | wc -l || echo "No temp files found"

      - name: Run cargo clippy
        run: cargo clippy --all-targets --locked -- -D warnings

      - name: Check disk space after clippy
        run: |
          echo "Disk space after clippy:"
          df -h

      - name: Run cargo fmt
        run: cargo fmt --all -- --check

      - name: Run cargo nextest with coverage (all tests including integration)
        run: |
          mkdir -p .coverage-tmp
          # This requires AWS credentials to be configured (done above)
          # Dex is started above for OAuth/OIDC integration tests
          echo "Disk space before coverage tests:"
          df -h
          # Run tests with coverage
          # --no-fail-fast: continue running even if tests fail
          # --status-level all: show all test results
          # --final-status-level slow: show slow tests at the end
          cargo llvm-cov nextest --workspace --locked --lcov --output-path .coverage-tmp/rust.lcov --no-fail-fast --status-level all --final-status-level slow
          echo "Disk space after coverage tests:"
          df -h
        timeout-minutes: 30

      - name: Upload Rust coverage LCOV
        uses: actions/upload-artifact@v4
        with:
          name: rust-coverage-lcov
          path: .coverage-tmp/rust.lcov
          retention-days: 7
          if-no-files-found: error

  napi-quality:
    name: NAPI build verification
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          components: ''

      - name: Setup pnpm and Node.js
        uses: ./.github/actions/setup-pnpm-node
        with:
          install-dependencies: 'true'

      - name: Verify sdk-js NAPI build (native platform only)
        working-directory: crates/sdk-js
        run: |
          echo "Building NAPI module for native platform to verify build succeeds..."
          pnpm run build
          echo "✓ NAPI build successful"

  pyo3-quality:
    name: PyO3 build verification
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          components: ''

      - name: Setup uv and Python
        uses: ./.github/actions/setup-uv-python
        with:
          python-version: '3.12'
          install-dependencies: 'false'
          enable-cache: 'false'

      - name: Verify sdk-py PyO3 build (native platform only)
        working-directory: crates/sdk-py
        run: |
          echo "Building PyO3 module for native platform to verify build succeeds..."
          pip install maturin
          maturin build --release
          echo "✓ PyO3 build successful"

  py-quality:
    name: Python quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          components: ''

      - name: Setup uv and Python
        uses: ./.github/actions/setup-uv-python
        with:
          python-version: '3.12'
          install-dependencies: 'true'

      - name: Run Python linters
        run: |
          set -e
          echo "Running ruff check..."
          uv run ruff check py/
          echo "Running ruff format check..."
          uv run ruff format --check py/
          echo "✓ Python linters passed"

      - name: Run mypy type checking
        run: |
          echo "Running mypy (sdk only, api_client is auto-generated)..."
          uv run mypy py/packages/sdk --ignore-missing-imports --exclude 'py/packages/api_client/.*'
          echo "✓ Type checking complete"

      - name: Run Python tests with coverage
        run: |
          echo "Running pytest with coverage..."
          mkdir -p .coverage-tmp
          uv run pytest py/packages/sdk/tests -v --tb=short --cov=py/packages/sdk/trysoma_sdk --cov-report=lcov:.coverage-tmp/py.lcov --cov-report=term
          echo "✓ Python tests complete"

      - name: Upload Python coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: py-coverage-lcov
          path: .coverage-tmp/py.lcov
          retention-days: 7
          if-no-files-found: error

  ts-quality:
    name: TypeScript quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup pnpm and Node.js
        uses: ./.github/actions/setup-pnpm-node
        with:
          install-dependencies: 'true'

      - name: Run pnpm lint:ci
        run: |
          set -e
          pnpm -r --workspace-concurrency=1  run lint:ci

      - name: Run tests with coverage
        run: |
          mkdir -p .coverage-tmp
          pnpm -r --workspace-concurrency=1 --filter './js/packages/*' --filter './crates/sdk-js' run test:coverage

      - name: Collect JS coverage reports
        uses: ./.github/actions/collect-js-coverage

      - name: Debug coverage directory
        run: |
          echo "Current directory: $(pwd)"
          echo "Contents of .coverage-tmp:"
          ls -la .coverage-tmp/ || echo "Directory doesn't exist"
          echo "Finding lcov files:"
          find .coverage-tmp -name "*.lcov" -type f || echo "No lcov files found"

      - name: Upload JS coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: js-coverage-lcov
          path: .coverage-tmp/
          retention-days: 7
          if-no-files-found: error
          include-hidden-files: true

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [rust-quality, ts-quality, py-quality]
    permissions:
      contents: read
      pull-requests: write
    # Only run if all test jobs pass
    if: |
      needs.rust-quality.result == 'success' &&
      needs.ts-quality.result == 'success' &&
      needs.py-quality.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Fetch main branch
        run: |
          git fetch origin main:main || git fetch origin main

      - name: Download Rust coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: rust-coverage-lcov
          path: ./coverage/rust/

      - name: Download JS coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: js-coverage-lcov
          path: ./coverage/js/

      - name: Download Python coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: py-coverage-lcov
          path: ./coverage/py/

      - name: Merge coverage reports
        id: merge-coverage
        uses: ./.github/actions/merge-coverage
        with:
          codecov-token: ${{ secrets.CODECOV_TOKEN }}

      - name: Compare coverage with main branch
        id: coverage-compare
        uses: ./.github/actions/coverage-compare
        with:
          current-lines: ${{ steps.merge-coverage.outputs.lines_coverage }}
          current-functions: ${{ steps.merge-coverage.outputs.functions_coverage }}
          current-branches: ${{ steps.merge-coverage.outputs.branches_coverage }}

      - name: Comment coverage report on PR
        uses: ./.github/actions/coverage-comment
        with:
          has-coverage: ${{ steps.merge-coverage.outputs.has_coverage }}
          has-baseline: ${{ steps.coverage-compare.outputs.has_baseline }}
          lines-coverage: ${{ steps.merge-coverage.outputs.lines_coverage }}
          functions-coverage: ${{ steps.merge-coverage.outputs.functions_coverage }}
          branches-coverage: ${{ steps.merge-coverage.outputs.branches_coverage }}
          coverage-summary: ${{ steps.merge-coverage.outputs.coverage_summary }}
          lines-diff: ${{ steps.coverage-compare.outputs.lines_diff }}
          functions-diff: ${{ steps.coverage-compare.outputs.functions_diff }}
          branches-diff: ${{ steps.coverage-compare.outputs.branches_diff }}
          codecov-repo: ${{ github.repository }}
