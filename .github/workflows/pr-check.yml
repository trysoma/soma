name: PR Checks

on:
  - pull_request
permissions:
  pull-requests: write
  contents: read
  id-token: write

jobs:
  db-quality:
    name: Database quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Fetch main branch
        run: |
          git fetch origin main
          git branch main origin/main 2>/dev/null || git checkout -b main origin/main 2>/dev/null || true

      - name: Install Atlas CLI
        run: |
          curl -sSf https://atlasgo.sh | sh -s -- --community -y
          echo "$HOME/.atlas/bin" >> $GITHUB_PATH

      - name: Validate Soma database migrations
        uses: ./.github/actions/atlas-migrate-lint
        with:
          env: soma
          git-base: main
          comment-tag: soma-db-quality
          display-name: Soma Database

      - name: Validate Bridge database migrations
        uses: ./.github/actions/atlas-migrate-lint
        with:
          env: bridge
          git-base: main
          comment-tag: bridge-db-quality
          display-name: Bridge Database

  api-quality:
    name: API quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Download OpenAPI spec from main via API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3.raw" \
                -o ./openapi-main.json \
                https://api.github.com/repos/${{ github.repository }}/contents/openapi.json?ref=main

      - name: Running OpenAPI Spec diff check
        uses: oasdiff/oasdiff-action/diff@main
        id: diff
        with:
          base: ./openapi-main.json
          revision: ./openapi.json

      - name: Comment OpenAPI Spec diff on PR
        uses: thollander/actions-comment-pull-request@v3
        with:
          mode: upsert
          comment-tag: api-quality
          message: |
            OpenAPI Spec diff report:
            ```
            ${{ steps.diff.outputs.diff }}
            ```

      - name: Running OpenAPI Spec breaking changes check
        id: breaking
        uses: oasdiff/oasdiff-action/breaking@main
        with:
          base: ./openapi-main.json
          revision: ./openapi.json
          fail-on: ERR

      - name: Comment Breaking changes on PR
        uses: thollander/actions-comment-pull-request@v3
        if: always()
        with:
          mode: upsert
          comment-tag: api-spec-diff
          message: |
            OpenAPI Spec Breaking changes report:
            ```
            ${{ steps.breaking.outputs.breaking }}
            ```

      # TODO: add API changelog generation action at some point
        
  rust-quality:
    name: Rust quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      # Disable incremental compilation for faster from-scratch builds
      CARGO_INCREMENTAL: 0
      CARGO_PROFILE_TEST_DEBUG: 0
      CARGO_PROFILE_RELEASE_LTO: true
      CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Configure AWS Credentials for integration tests
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          audience: sts.amazonaws.com
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.AWS_INTEGRATION_TESTS_ROLE_ARN }}

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Install cargo-llvm-cov and cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov,cargo-nextest

      - name: Run cargo clippy
        run: cargo clippy --all-targets --all-features --locked -- -D warnings

      - name: Run cargo fmt
        run: cargo fmt --all -- --check

      - name: Run cargo nextest with coverage
        run: |
          mkdir -p .coverage-tmp
          cargo llvm-cov nextest --all-features --workspace --locked --lcov --output-path .coverage-tmp/rust.lcov

      - name: Upload Rust coverage LCOV
        uses: actions/upload-artifact@v4
        with:
          name: rust-coverage-lcov
          path: .coverage-tmp/rust.lcov
          retention-days: 7
          if-no-files-found: error


  napi-quality:
    name: NAPI build verification
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          components: ''

      - name: Setup pnpm and Node.js
        uses: ./.github/actions/setup-pnpm-node
        with:
          install-dependencies: 'true'

      - name: Verify sdk-js NAPI build (native platform only)
        working-directory: crates/sdk-js
        run: |
          echo "Building NAPI module for native platform to verify build succeeds..."
          pnpm run build
          echo "âœ“ NAPI build successful"

  ts-quality:
    name: TypeScript quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup pnpm and Node.js
        uses: ./.github/actions/setup-pnpm-node
        with:
          install-dependencies: 'true'

      - name: Run pnpm lint:ci
        run: |
          set -e
          pnpm -r --workspace-concurrency=1  run lint:ci

      - name: Run tests with coverage
        run: |
          mkdir -p .coverage-tmp
          pnpm -r --workspace-concurrency=1 --filter './js/packages/*' --filter './crates/sdk-js' run test:coverage

      - name: Collect JS coverage reports
        uses: ./.github/actions/collect-js-coverage

      - name: Debug coverage directory
        run: |
          echo "Current directory: $(pwd)"
          echo "Contents of .coverage-tmp:"
          ls -la .coverage-tmp/ || echo "Directory doesn't exist"
          echo "Finding lcov files:"
          find .coverage-tmp -name "*.lcov" -type f || echo "No lcov files found"

      - name: Upload JS coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: js-coverage-lcov
          path: .coverage-tmp/
          retention-days: 7
          if-no-files-found: error
          include-hidden-files: true

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [rust-quality, ts-quality]
    permissions:
      contents: read
      pull-requests: write
    # Only run if both test jobs pass
    if: |
      needs.rust-quality.result == 'success' &&
      needs.ts-quality.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Fetch main branch
        run: |
          git fetch origin main:main || git fetch origin main

      - name: Download Rust coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: rust-coverage-lcov
          path: ./coverage/rust/

      - name: Download JS coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: js-coverage-lcov
          path: ./coverage/js/

      - name: Merge coverage reports
        id: merge-coverage
        uses: ./.github/actions/merge-coverage
        with:
          codecov-token: ${{ secrets.CODECOV_TOKEN }}

      - name: Compare coverage with main branch
        id: coverage-compare
        uses: ./.github/actions/coverage-compare
        with:
          current-lines: ${{ steps.merge-coverage.outputs.lines_coverage }}
          current-functions: ${{ steps.merge-coverage.outputs.functions_coverage }}
          current-branches: ${{ steps.merge-coverage.outputs.branches_coverage }}

      - name: Comment coverage report on PR
        uses: ./.github/actions/coverage-comment
        with:
          has-coverage: ${{ steps.merge-coverage.outputs.has_coverage }}
          has-baseline: ${{ steps.coverage-compare.outputs.has_baseline }}
          lines-coverage: ${{ steps.merge-coverage.outputs.lines_coverage }}
          functions-coverage: ${{ steps.merge-coverage.outputs.functions_coverage }}
          branches-coverage: ${{ steps.merge-coverage.outputs.branches_coverage }}
          coverage-summary: ${{ steps.merge-coverage.outputs.coverage_summary }}
          lines-diff: ${{ steps.coverage-compare.outputs.lines_diff }}
          functions-diff: ${{ steps.coverage-compare.outputs.functions_diff }}
          branches-diff: ${{ steps.coverage-compare.outputs.branches_diff }}
          codecov-repo: ${{ github.repository }}
