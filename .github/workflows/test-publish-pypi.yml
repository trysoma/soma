name: Test PyPI Publish

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID to download artifacts from'
        required: true
        type: string
        default: '20032215670'
      version:
        description: 'Version to publish (e.g., v0.0.5-snapshot-0)'
        required: true
        type: string
        default: 'v0.0.5-snapshot-1'

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  test-publish:
    name: Test PyPI Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Download release changes
        uses: actions/download-artifact@v4
        with:
          name: release-changes
          run-id: ${{ inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply release changes
        run: tar -xzf release-changes.tar.gz
        shell: bash

      - name: Setup uv and Python
        uses: ./.github/actions/setup-uv-python
        with:
          python-version: '3.12'
          working-directory: py
          install-dependencies: 'false'

      - name: Download all Python wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: py-wheels-*
          path: py-wheels
          merge-multiple: true
          run-id: ${{ inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug - Show downloaded artifacts
        run: |
          echo "=== Contents of py-wheels directory ==="
          ls -laR py-wheels/ || echo "py-wheels directory does not exist"
          echo ""
          echo "=== All .whl files ==="
          find . -name "*.whl" -type f 2>/dev/null || echo "No wheel files found"
          echo ""
          echo "=== All .tar.gz files ==="
          find . -name "*.tar.gz" -type f 2>/dev/null || echo "No tar.gz files found"
        shell: bash

      - name: Prepare wheels for upload
        run: |
          mkdir -p dist
          echo "Collecting Python wheels from artifacts..."

          # Find and copy all wheel files
          find py-wheels -name "*.whl" -type f | while read file; do
            echo "  Copying: $file"
            cp "$file" dist/
          done

          # Find and copy source distribution
          find py-wheels -name "*.tar.gz" -type f | while read file; do
            echo "  Copying: $file"
            cp "$file" dist/
          done

          echo ""
          echo "Wheels ready for upload:"
          ls -la dist/

          # Fail early if no wheels were found
          if [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
            echo "ERROR: No wheel files found in dist directory!"
            exit 1
          fi
        shell: bash

      - name: Publish soma-sdk-core to PyPI
        uses: PyO3/maturin-action@v1
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        with:
          command: upload
          args: --non-interactive --skip-existing dist/*

      - name: Build pure Python packages
        run: |
          VERSION="${{ inputs.version }}"
          VERSION_NUMBER="${VERSION#v}"

          echo "Building pure Python packages..."

          # Build trysoma-sdk package
          echo "Building trysoma-sdk..."
          cd py/packages/sdk
          uv build --out-dir dist
          echo "=== SDK dist contents ==="
          ls -la dist/
          cd ../../..

          # Build trysoma-api-client package
          echo "Building trysoma-api-client..."
          cd py/packages/api_client
          uv build --out-dir dist
          echo "=== API client dist contents ==="
          ls -la dist/
          cd ../../..
        shell: bash

      - name: Publish pure Python packages to PyPI
        run: |
          echo "Publishing packages to PyPI..."

          # Publish trysoma-sdk
          echo "Publishing trysoma-sdk..."
          uv publish --token "${{ secrets.PYPI_API_TOKEN }}" \
            py/packages/sdk/dist/*

          # Publish trysoma-api-client
          echo "Publishing trysoma-api-client..."
          uv publish --token "${{ secrets.PYPI_API_TOKEN }}" \
            py/packages/api_client/dist/*

          echo "All Python packages published to PyPI"
        shell: bash

      - name: Verify published packages
        run: |
          VERSION="${{ inputs.version }}"
          VERSION_NUMBER="${VERSION#v}"

          echo "Verifying packages on PyPI..."
          sleep 10  # Wait for PyPI to index

          # Check package availability
          pip index versions trysoma-sdk-core 2>/dev/null | head -5 || echo "trysoma-sdk-core check skipped"
          pip index versions trysoma-sdk 2>/dev/null | head -5 || echo "trysoma-sdk check skipped"
          pip index versions trysoma-api-client 2>/dev/null | head -5 || echo "trysoma-api-client check skipped"
        shell: bash
