name: Main Branch Coverage

on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

jobs:
  rust-tests:
    name: Rust Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      CARGO_INCREMENTAL: 0
      CARGO_PROFILE_TEST_DEBUG: 0
      CARGO_PROFILE_RELEASE_LTO: true
      CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Configure AWS Credentials for integration tests
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          audience: sts.amazonaws.com
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.AWS_INTEGRATION_TESTS_ROLE_ARN }}

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Install cargo-llvm-cov and cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov,cargo-nextest

      - name: Run cargo nextest with coverage
        run: |
          mkdir -p .coverage-tmp
          cargo llvm-cov nextest --all-features --workspace --locked --lcov --output-path .coverage-tmp/rust.lcov

      - name: Upload Rust coverage LCOV
        uses: actions/upload-artifact@v4
        with:
          name: rust-coverage-lcov
          path: .coverage-tmp/rust.lcov
          retention-days: 7
          if-no-files-found: error

  ts-tests:
    name: TypeScript Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup pnpm and Node.js
        uses: ./.github/actions/setup-pnpm-node
        with:
          install-dependencies: 'true'

      - name: Run tests with coverage
        run: |
          mkdir -p .coverage-tmp
          pnpm -r --workspace-concurrency=1 --filter './js/packages/*' --filter './crates/sdk-js' run test:coverage

      - name: Collect JS coverage reports
        if: always()
        run: |
          echo "=== Searching for lcov.info files ==="
          find . -name 'lcov.info' -type f -not -path './coverage/*' -not -path './node_modules/*' -not -path './js/examples/*' || echo "No lcov.info files found"

          echo ""
          echo "=== Collecting coverage files ==="
          mkdir -p .coverage-tmp
          count=0

          while IFS= read -r file; do
            dir=$(dirname "$file")
            pkgdir=$(dirname "$dir")
            name=$(echo "$pkgdir" | sed 's/^\.\///' | sed 's/\//-/g')
            output_file=".coverage-tmp/js-$name.lcov"
            echo "✓ Processing: $file -> $output_file"

            sed "s|^SF:|SF:$pkgdir/|g" "$file" > "$output_file"
            count=$((count + 1))
          done < <(find . -name 'lcov.info' -type f -not -path './coverage/*' -not -path './node_modules/*' -not -path './js/examples/*')

          echo ""
          if [ "$count" -eq 0 ]; then
            echo "❌ ERROR: No coverage files found!"
            echo "Expected to find lcov.info files in JS packages but none were generated."
            exit 1
          else
            echo "✓ Successfully collected $count coverage file(s)"
          fi

          echo ""
          echo "=== Coverage files in .coverage-tmp ==="
          ls -la .coverage-tmp/

      - name: Upload JS coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: js-coverage-lcov
          path: .coverage-tmp/
          retention-days: 7
          if-no-files-found: error
          include-hidden-files: true

  merge-and-store-coverage:
    name: Merge and Store Coverage
    runs-on: ubuntu-latest
    needs: [rust-tests, ts-tests]
    permissions:
      contents: write
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Download Rust coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: rust-coverage-lcov
          path: ./coverage/rust/

      - name: Download JS coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: js-coverage-lcov
          path: ./coverage/js/

      - name: Setup Node.js for lcov-merger
        uses: ./.github/actions/setup-pnpm-node

      - name: Install lcov tools
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov bc

      - name: Merge coverage reports
        id: merge-coverage
        run: |
          mkdir -p ./coverage/merged

          # Collect all LCOV files
          lcov_files=""
          if [ -f ./coverage/rust/rust.lcov ]; then
            echo "✓ Found Rust coverage: ./coverage/rust/rust.lcov"
            lcov_files="$lcov_files ./coverage/rust/rust.lcov"
          else
            echo "✗ Rust coverage not found at ./coverage/rust/rust.lcov"
          fi

          if [ -d ./coverage/js ]; then
            echo "✓ JS coverage directory exists"
            for file in ./coverage/js/js-*.lcov; do
              if [ -f "$file" ]; then
                echo "✓ Found JS coverage: $file"
                lcov_files="$lcov_files $file"
              fi
            done

            if [ -f ./coverage/js/.no-coverage ]; then
              echo "⚠ Found .no-coverage marker - no JS coverage was generated"
            fi
          else
            echo "✗ JS coverage directory not found at ./coverage/js"
          fi

          # Merge LCOV files
          if [ -n "$lcov_files" ]; then
            echo "=== Merging coverage files: $lcov_files ==="

            # Build lcov arguments dynamically
            lcov_args=""
            for file in $lcov_files; do
              lcov_args="$lcov_args -a $file"
            done

            echo "Running: lcov $lcov_args -o ./coverage/merged/coverage.lcov"

            # Merge with lcov (handles mixed llvm/istanbul formats correctly)
            lcov $lcov_args -o ./coverage/merged/coverage.lcov
            echo "✓ Coverage merge completed"

            # Verify merged file exists
            if [ ! -f ./coverage/merged/coverage.lcov ]; then
              echo "❌ ERROR: Merged coverage file was not created!"
              exit 1
            fi

            echo "=== Merged coverage file info ==="
            ls -lh ./coverage/merged/coverage.lcov
          else
            echo "❌ ERROR: No coverage files found to merge!"
            exit 1
          fi

          # Parse coverage metrics from merged LCOV
          echo "=== Generating coverage summary ==="
          coverage_summary=$(lcov --summary ./coverage/merged/coverage.lcov 2>&1 | grep -E "lines|functions|branches" | head -3)

          echo "Coverage summary:"
          echo "$coverage_summary"

          # Extract percentages
          lines_coverage=$(echo "$coverage_summary" | grep "lines" | grep -oE "[0-9]+\.[0-9]+%" | head -1 | sed 's/%//' || echo "0")
          functions_coverage=$(echo "$coverage_summary" | grep "functions" | grep -oE "[0-9]+\.[0-9]+%" | head -1 | sed 's/%//' || echo "0")
          branches_coverage=$(echo "$coverage_summary" | grep "branches" | grep -oE "[0-9]+\.[0-9]+%" | head -1 | sed 's/%//' || echo "0")

          echo "Extracted coverage:"
          echo "  Lines: $lines_coverage%"
          echo "  Functions: $functions_coverage%"
          echo "  Branches: $branches_coverage%"

          # Store metrics in a JSON file
          mkdir -p .coverage-metrics
          cat > .coverage-metrics/main-coverage.json <<EOF
          {
            "lines": "$lines_coverage",
            "functions": "$functions_coverage",
            "branches": "$branches_coverage",
            "commit": "${{ github.sha }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          echo "✓ Coverage metrics saved to .coverage-metrics/main-coverage.json"
          cat .coverage-metrics/main-coverage.json

      - name: Upload coverage metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: main-coverage-metrics
          path: .coverage-metrics/main-coverage.json
          retention-days: 45
          if-no-files-found: error

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/merged/coverage.lcov
          fail_ci_if_error: false
          verbose: true
          token: ${{ secrets.CODECOV_TOKEN }}
