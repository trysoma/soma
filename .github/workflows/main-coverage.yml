name: Main Branch Coverage

on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

jobs:
  rust-tests:
    name: Rust Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      CARGO_INCREMENTAL: 0
      CARGO_PROFILE_TEST_DEBUG: 0
      CARGO_PROFILE_RELEASE_LTO: true
      CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Configure AWS Credentials for integration tests
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          audience: sts.amazonaws.com
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.AWS_INTEGRATION_TESTS_ROLE_ARN }}

      - name: Start Dex (OIDC/OAuth2 provider) for integration tests
        uses: ./.github/actions/setup-docker-compose
        with:
          compose-file: ./test/docker-compose.yml
          health-check-url: http://localhost:5556/dex/keys

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Install cargo-llvm-cov and cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov,cargo-nextest

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h

      - name: Run cargo nextest with coverage
        run: |
          mkdir -p .coverage-tmp
          # This requires AWS credentials to be configured (done above)
          # Dex is started above for OAuth/OIDC integration tests
          cargo llvm-cov nextest --workspace --locked --lcov --output-path .coverage-tmp/rust.lcov --no-fail-fast --status-level all --final-status-level slow
        env:
          NEXTEST_RETRIES: 0

      - name: Upload Rust coverage LCOV
        uses: actions/upload-artifact@v4
        with:
          name: rust-coverage-lcov
          path: .coverage-tmp/rust.lcov
          retention-days: 7
          if-no-files-found: error

  ts-tests:
    name: TypeScript Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup pnpm and Node.js
        uses: ./.github/actions/setup-pnpm-node
        with:
          install-dependencies: 'true'

      - name: Run tests with coverage
        run: |
          mkdir -p .coverage-tmp
          pnpm -r --workspace-concurrency=1 --filter './js/packages/*' --filter './crates/sdk-js' run test:coverage

      - name: Collect JS coverage reports
        uses: ./.github/actions/collect-js-coverage

      - name: Upload JS coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: js-coverage-lcov
          path: .coverage-tmp/
          retention-days: 7
          if-no-files-found: error
          include-hidden-files: true

  py-tests:
    name: Python Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          components: ''

      - name: Setup uv and Python
        uses: ./.github/actions/setup-uv-python
        with:
          python-version: '3.12'
          install-dependencies: 'true'

      - name: Run Python tests with coverage
        run: |
          echo "Running pytest with coverage..."
          mkdir -p .coverage-tmp
          uv run pytest py/packages/sdk/tests -v --tb=short --cov=py/packages/sdk/trysoma_sdk --cov-report=lcov:.coverage-tmp/py.lcov --cov-report=term
          echo "✓ Python tests complete"

      - name: Upload Python coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: py-coverage-lcov
          path: .coverage-tmp/py.lcov
          retention-days: 7
          if-no-files-found: error

  merge-and-store-coverage:
    name: Merge and Store Coverage
    runs-on: ubuntu-latest
    needs: [rust-tests, ts-tests, py-tests]
    permissions:
      contents: write
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Download Rust coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: rust-coverage-lcov
          path: ./coverage/rust/

      - name: Download JS coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: js-coverage-lcov
          path: ./coverage/js/

      - name: Download Python coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: py-coverage-lcov
          path: ./coverage/py/

      - name: Merge coverage reports
        id: merge-coverage
        uses: ./.github/actions/merge-coverage
        with:
          codecov-token: ${{ secrets.CODECOV_TOKEN }}

      - name: Store coverage metrics as JSON
        run: |
          mkdir -p .coverage-metrics
          cat > .coverage-metrics/main-coverage.json <<EOF
          {
            "lines": "${{ steps.merge-coverage.outputs.lines_coverage }}",
            "functions": "${{ steps.merge-coverage.outputs.functions_coverage }}",
            "branches": "${{ steps.merge-coverage.outputs.branches_coverage }}",
            "commit": "${{ github.sha }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          echo "✓ Coverage metrics saved to .coverage-metrics/main-coverage.json"
          cat .coverage-metrics/main-coverage.json

      - name: Upload coverage metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: main-coverage-metrics
          path: .coverage-metrics/main-coverage.json
          retention-days: 45
          if-no-files-found: error
