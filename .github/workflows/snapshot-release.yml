name: Snapshot Release

on:
  workflow_dispatch:
    inputs:
      prerelease-label:
        description: 'Prerelease label'
        required: true
        type: choice
        options:
          - snapshot
          - rc
      revision:
        description: 'Branch or tag to release from'
        required: true
        type: string
        default: 'main'
      semantic-version:
        description: 'Semantic version (leave empty to auto-calculate from changie)'
        required: false
        type: string

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  prepare-release:
    uses: ./.github/workflows/common-prepare-release.yml
    with:
      release-type: snapshot
      revision: ${{ inputs.revision }}
      prerelease-label: ${{ inputs.prerelease-label }}
      semantic-version: ${{ inputs.semantic-version }}
    secrets:
      TRY_SOMA_BOT_TOKEN: ${{ secrets.TRY_SOMA_BOT_TOKEN }}

  create-changelog-and-artifacts:
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.revision }}
          fetch-depth: 0
          token: ${{ secrets.TRY_SOMA_BOT_TOKEN }}

      - name: Setup Changie
        uses: miniscruff/changie-action@v2.1.0
        with:
          version: latest

      - name: Calculate base version
        id: base-version
        run: |
          if [ -n "${{ inputs.semantic-version }}" ]; then
            BASE_VERSION="${{ inputs.semantic-version }}"
            if [[ ! "$BASE_VERSION" =~ ^v ]]; then
              BASE_VERSION="v$BASE_VERSION"
            fi
            echo "Using provided version: $BASE_VERSION"
          else
            echo "Calculating next version from changie..."
            BASE_VERSION=$(changie next auto)
            if [ $? -ne 0 ] || [ -z "$BASE_VERSION" ]; then
              echo "Error: Failed to calculate next version from changie"
              exit 1
            fi
            echo "Calculated version: $BASE_VERSION"
          fi
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT

      - name: Calculate prerelease increment
        id: calculate-increment
        run: |
          BASE_VERSION="${{ steps.base-version.outputs.base_version }}"
          LABEL="${{ inputs.prerelease-label }}"

          echo "Finding existing prerelease tags for $BASE_VERSION-$LABEL-*"

          # Get all tags matching the pattern
          EXISTING_TAGS=$(git tag -l "${BASE_VERSION}-${LABEL}-*" | sort -V)

          if [ -z "$EXISTING_TAGS" ]; then
            echo "No existing tags found, starting at 0"
            INCREMENT=0
          else
            echo "Found existing tags:"
            echo "$EXISTING_TAGS"

            # Extract the highest increment number
            HIGHEST=$(echo "$EXISTING_TAGS" | sed "s/${BASE_VERSION}-${LABEL}-//" | sort -n | tail -1)
            INCREMENT=$((HIGHEST + 1))
            echo "Highest increment found: $HIGHEST, using: $INCREMENT"
          fi

          echo "increment=$INCREMENT" >> $GITHUB_OUTPUT

      - name: Set changie environment variables
        run: |
          # Set environment variables with CHANGIE_ prefix for changie injection
          # changie will strip the prefix and make them available as .Env.OPENAPI_DIFF and .Env.DATABASE_SCHEMA_DIFF
          echo "CHANGIE_OPENAPI_DIFF<<EOF" >> $GITHUB_ENV
          echo "${{ needs.prepare-release.outputs.openapi_diff }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "CHANGIE_DATABASE_SCHEMA_DIFF<<EOF" >> $GITHUB_ENV
          echo "${{ needs.prepare-release.outputs.database_schema_diff }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create prerelease changelog
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          LABEL="${{ inputs.prerelease-label }}"
          INCREMENT="${{ steps.calculate-increment.outputs.increment }}"

          echo "Creating changelog for prerelease: $VERSION"
          changie batch "$VERSION" --prerelease "${LABEL}-${INCREMENT}" --move-dir=prerelease
          changie merge
          cat CHANGELOG.md

      - name: Create schema change files
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          # Remove 'v' prefix but keep prerelease suffix for snapshot releases (e.g., v0.0.2-snapshot-0 -> 0.0.2-snapshot-0)
          VERSION_NO_V=$(echo "$VERSION" | sed 's/^v//')
          
          # Create OpenAPI schema change file
          OPENAPI_FILE=".changes/v${VERSION_NO_V}.api.md"
          echo "Creating $OPENAPI_FILE"
          {
            echo "### OpenAPI Schema Changes"
            echo "(for release version ${VERSION_NO_V})"
            echo ""
            echo '```'
            echo "${{ needs.prepare-release.outputs.openapi_diff }}"
            echo '```'
          } > "$OPENAPI_FILE"
          
          # Create database schema change file
          DB_FILE=".changes/v${VERSION_NO_V}.db.md"
          echo "Creating $DB_FILE"
          {
            echo "### Database Schema Changes"
            echo "(for release version ${VERSION_NO_V})"
            echo ""
            echo '```'
            echo "${{ needs.prepare-release.outputs.database_schema_diff }}"
            echo '```'
          } > "$DB_FILE"
          
          echo "Created schema change files:"
          ls -la "$OPENAPI_FILE" "$DB_FILE" 2>/dev/null || echo "Some files may not exist if there were no changes"

      - name: Convert Python versions to PEP 440 format
        run: |
          # PEP 440 doesn't support semver-style prereleases like "0.0.5-snapshot-0"
          # Convert to PEP 440 compliant format:
          #   - snapshot-N -> .devN (development release)
          #   - rc-N -> rcN (release candidate)

          LABEL="${{ inputs.prerelease-label }}"
          INCREMENT="${{ steps.calculate-increment.outputs.increment }}"
          BASE_VERSION="${{ steps.base-version.outputs.base_version }}"
          # Remove 'v' prefix if present
          BASE_VERSION_NO_V="${BASE_VERSION#v}"

          # Determine PEP 440 suffix based on prerelease label
          if [ "$LABEL" = "snapshot" ]; then
            PEP440_SUFFIX=".dev${INCREMENT}"
          elif [ "$LABEL" = "rc" ]; then
            PEP440_SUFFIX="rc${INCREMENT}"
          else
            echo "Unknown prerelease label: $LABEL"
            exit 1
          fi

          PEP440_VERSION="${BASE_VERSION_NO_V}${PEP440_SUFFIX}"
          echo "Converting Python versions to PEP 440 format: $PEP440_VERSION"

          # List of Python pyproject.toml files to update
          PYPROJECT_FILES=(
            "crates/sdk-py/pyproject.toml"
            "py/packages/sdk/pyproject.toml"
            "py/packages/api_client/pyproject.toml"
            "py/pyproject.toml"
          )

          for file in "${PYPROJECT_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "Updating $file..."
              # Replace semver prerelease format with PEP 440 format
              # e.g., version = "0.0.5-snapshot-0" -> version = "0.0.5.dev0"
              # e.g., version = "0.0.5-rc-0" -> version = "0.0.5rc0"
              sed -i.bak -E "s/^(version = \"[0-9]+\.[0-9]+\.[0-9]+)-${LABEL}-[0-9]+\"/\1${PEP440_SUFFIX}\"/" "$file"
              rm -f "${file}.bak"
              echo "  Updated version in $file:"
              grep '^version = ' "$file" || true
            else
              echo "Warning: $file not found, skipping"
            fi
          done

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          components: ''
          install-protoc: 'false'

      - name: Update Cargo.lock
        run: |
          echo "Updating Cargo.lock for version ${{ needs.prepare-release.outputs.version }}"
          cargo update --workspace

      - name: Update sdk-py Cargo.toml for maturin compatibility
        run: |
          # Maturin validates Cargo.toml version even when pyproject.toml has explicit version.
          # Set sdk-py Cargo.toml to base semver (without prerelease suffix) so Cargo is happy,
          # while pyproject.toml has the PEP 440 .devN version that maturin will use for the package.

          LABEL="${{ inputs.prerelease-label }}"
          INCREMENT="${{ steps.calculate-increment.outputs.increment }}"
          BASE_VERSION="${{ steps.base-version.outputs.base_version }}"
          BASE_VERSION_NO_V="${BASE_VERSION#v}"

          SDK_PY_CARGO="crates/sdk-py/Cargo.toml"
          if [ -f "$SDK_PY_CARGO" ]; then
            echo "Updating $SDK_PY_CARGO with base semver version: $BASE_VERSION_NO_V"
            # Replace version.workspace = true with explicit base version (no prerelease suffix)
            sed -i.bak -E "s/^version\.workspace = true$/version = \"${BASE_VERSION_NO_V}\"/" "$SDK_PY_CARGO"
            rm -f "${SDK_PY_CARGO}.bak"
            echo "  Updated version in $SDK_PY_CARGO:"
            grep '^version' "$SDK_PY_CARGO" | head -1

            # Regenerate Cargo.lock after modifying Cargo.toml
            echo "Regenerating Cargo.lock..."
            cargo update -p sdk-py
          fi

      - name: Create release artifact
        run: |
          # Capture all modified files (including any Cargo.toml version changes)
          # Use git status to find all modified/new files
          git add -A

          # Create tarball of all changes using --files-from to handle special characters
          git diff --cached --name-only --diff-filter=ACMR > /tmp/changed-files.txt

          # Also add the frontend dist directory (not tracked by git)
          if [ -d "crates/soma-frontend/app/dist" ]; then
            echo "Adding frontend dist directory to artifact"
            find crates/soma-frontend/app/dist -type f >> /tmp/changed-files.txt
          fi

          if [ -s /tmp/changed-files.txt ]; then
            echo "Packaging changed files:"
            cat /tmp/changed-files.txt
            tar -czf release-changes.tar.gz --files-from=/tmp/changed-files.txt
          else
            echo "No changes detected, creating empty tarball"
            tar -czf release-changes.tar.gz --files-from /dev/null
          fi

      - name: Upload release changes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-changes
          path: release-changes.tar.gz
          retention-days: 1

  build-core-js-sdk:
    needs: [prepare-release, create-changelog-and-artifacts]
    uses: ./.github/workflows/common-build-core-js-sdk.yml
    with:
      revision: ${{ inputs.revision }}

  build-core-py-sdk:
    needs: [prepare-release, create-changelog-and-artifacts]
    uses: ./.github/workflows/common-build-core-py-sdk.yml
    with:
      revision: ${{ inputs.revision }}

  test-sdk-js-macOS-windows-binding:
    needs: build-core-js-sdk
    uses: ./.github/workflows/common-test-sdk-js-macOS-windows-binding.yml

  test-linux-js-sdk-binding:
    needs: build-core-js-sdk
    uses: ./.github/workflows/common-test-linux-js-sdk-binding.yml

  build-soma:
    needs: [prepare-release, create-changelog-and-artifacts]
    uses: ./.github/workflows/common-build-soma.yml
    with:
      revision: ${{ inputs.revision }}
    secrets:
      AWS_INTEGRATION_TESTS_ROLE_ARN: ${{ secrets.AWS_INTEGRATION_TESTS_ROLE_ARN }}

  test-soma-macOS-windows:
    needs: build-soma
    uses: ./.github/workflows/common-test-soma-macOS-windows.yml
    with:
      revision: ${{ inputs.revision }}
    secrets:
      AWS_INTEGRATION_TESTS_ROLE_ARN: ${{ secrets.AWS_INTEGRATION_TESTS_ROLE_ARN }}

  test-soma-linux:
    needs: build-soma
    uses: ./.github/workflows/common-test-soma-linux.yml
    with:
      revision: ${{ inputs.revision }}
    secrets:
      AWS_INTEGRATION_TESTS_ROLE_ARN: ${{ secrets.AWS_INTEGRATION_TESTS_ROLE_ARN }}

  publish-npm:
    needs:
      - prepare-release
      - build-core-js-sdk
      - build-soma
      - test-sdk-js-macOS-windows-binding
      - test-linux-js-sdk-binding
      - test-soma-macOS-windows
      - test-soma-linux
    uses: ./.github/workflows/common-publish-npm.yml
    with:
      version: ${{ needs.prepare-release.outputs.version }}
      npm-tag: ${{ inputs.prerelease-label }}
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-pypi:
    needs:
      - prepare-release
      - build-core-py-sdk
      - build-soma
      - test-soma-macOS-windows
      - test-soma-linux
    uses: ./.github/workflows/common-publish-pypi.yml
    with:
      version: ${{ needs.prepare-release.outputs.version }}
    secrets:
      PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

  create-github-release:
    needs: [prepare-release, build-soma, build-core-js-sdk, build-core-py-sdk, publish-npm, publish-pypi]
    permissions:
      contents: write
    uses: ./.github/workflows/common-create-github-release.yml
    with:
      version: ${{ needs.prepare-release.outputs.version }}
      revision: ${{ inputs.revision }}
      prerelease: true
    secrets:
      TRY_SOMA_BOT_TOKEN: ${{ secrets.TRY_SOMA_BOT_TOKEN }}

  create-github-issue-on-fail:
    needs:
      - prepare-release
      - create-changelog-and-artifacts
      - build-core-js-sdk
      - build-core-py-sdk
      - test-sdk-js-macOS-windows-binding
      - test-linux-js-sdk-binding
      - build-soma
      - test-soma-macOS-windows
      - test-soma-linux
      - publish-npm
      - publish-pypi
      - create-github-release
    if: failure()
    permissions:
      issues: write
    uses: ./.github/workflows/common-create-github-issue-on-fail.yml
    with:
      version: ${{ needs.prepare-release.outputs.version }}
      workflow-type: snapshot-release
      failed-jobs: ${{ needs.prepare-release.result == 'failure' && 'prepare-release' || '' }}${{ needs.create-changelog-and-artifacts.result == 'failure' && format(',create-changelog-and-artifacts') || '' }}${{ needs.build-core-js-sdk.result == 'failure' && format(',build-core-js-sdk') || '' }}${{ needs.build-core-py-sdk.result == 'failure' && format(',build-core-py-sdk') || '' }}${{ needs.test-sdk-js-macOS-windows-binding.result == 'failure' && format(',test-sdk-js-macOS-windows-binding') || '' }}${{ needs.test-linux-js-sdk-binding.result == 'failure' && format(',test-linux-js-sdk-binding') || '' }}${{ needs.build-soma.result == 'failure' && format(',build-soma') || '' }}${{ needs.test-soma-macOS-windows.result == 'failure' && format(',test-soma-macOS-windows') || '' }}${{ needs.test-soma-linux.result == 'failure' && format(',test-soma-linux') || '' }}${{ needs.publish-npm.result == 'failure' && format(',publish-npm') || '' }}${{ needs.publish-pypi.result == 'failure' && format(',publish-pypi') || '' }}${{ needs.create-github-release.result == 'failure' && format(',create-github-release') || '' }}
