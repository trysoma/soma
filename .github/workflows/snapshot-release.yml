name: Snapshot Release

on:
  workflow_dispatch:
    inputs:
      prerelease-label:
        description: 'Prerelease label'
        required: true
        type: choice
        options:
          - snapshot
          - rc
      revision:
        description: 'Branch or tag to release from'
        required: true
        type: string
        default: 'main'
      semantic-version:
        description: 'Semantic version (leave empty to auto-calculate from changie)'
        required: false
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.calculate-version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.revision }}
          fetch-depth: 0
          token: ${{ secrets.TRY_SOMA_BOT_TOKEN }}

      - name: Setup Changie
        uses: miniscruff/changie-action@v2.1.0
        with:
          version: latest

      - name: Calculate base version
        id: base-version
        run: |
          if [ -n "${{ inputs.semantic-version }}" ]; then
            BASE_VERSION="${{ inputs.semantic-version }}"
            if [[ ! "$BASE_VERSION" =~ ^v ]]; then
              BASE_VERSION="v$BASE_VERSION"
            fi
            echo "Using provided version: $BASE_VERSION"
          else
            echo "Calculating next version from changie..."
            BASE_VERSION=$(changie next auto)
            if [ $? -ne 0 ] || [ -z "$BASE_VERSION" ]; then
              echo "Error: Failed to calculate next version from changie"
              exit 1
            fi
            echo "Calculated version: $BASE_VERSION"
          fi
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT

      - name: Calculate prerelease increment
        id: calculate-increment
        run: |
          BASE_VERSION="${{ steps.base-version.outputs.base_version }}"
          LABEL="${{ inputs.prerelease-label }}"

          echo "Finding existing prerelease tags for $BASE_VERSION-$LABEL-*"

          # Get all tags matching the pattern
          EXISTING_TAGS=$(git tag -l "${BASE_VERSION}-${LABEL}-*" | sort -V)

          if [ -z "$EXISTING_TAGS" ]; then
            echo "No existing tags found, starting at 0"
            INCREMENT=0
          else
            echo "Found existing tags:"
            echo "$EXISTING_TAGS"

            # Extract the highest increment number
            HIGHEST=$(echo "$EXISTING_TAGS" | sed "s/${BASE_VERSION}-${LABEL}-//" | sort -n | tail -1)
            INCREMENT=$((HIGHEST + 1))
            echo "Highest increment found: $HIGHEST, using: $INCREMENT"
          fi

          echo "increment=$INCREMENT" >> $GITHUB_OUTPUT

      - name: Calculate full version
        id: calculate-version
        run: |
          BASE_VERSION="${{ steps.base-version.outputs.base_version }}"
          LABEL="${{ inputs.prerelease-label }}"
          INCREMENT="${{ steps.calculate-increment.outputs.increment }}"

          FULL_VERSION="${BASE_VERSION}-${LABEL}-${INCREMENT}"
          echo "Full version: $FULL_VERSION"
          echo "version=$FULL_VERSION" >> $GITHUB_OUTPUT

      - name: Restore previous prerelease changes
        run: |
          BASE_VERSION="${{ steps.base-version.outputs.base_version }}"
          LABEL="${{ inputs.prerelease-label }}"
          INCREMENT="${{ steps.calculate-increment.outputs.increment }}"

          # If this is not the first increment (i > 0), restore previous changes
          if [ "$INCREMENT" -gt 0 ]; then
            PREV_INCREMENT=$((INCREMENT - 1))
            PREV_VERSION="${BASE_VERSION}-${LABEL}-${PREV_INCREMENT}"

            echo "Restoring changes from previous version: $PREV_VERSION"

            # Check if the previous tag exists
            if git rev-parse "$PREV_VERSION" >/dev/null 2>&1; then
              # Get all .changes files from the previous tag
              CHANGES_FILES=$(git ls-tree -r --name-only "$PREV_VERSION" .changes/ | grep -E "\.changes/${BASE_VERSION}-${LABEL}-.*\.md$" || true)

              if [ -n "$CHANGES_FILES" ]; then
                echo "Found previous changes files:"
                echo "$CHANGES_FILES"

                # Restore each file from the previous tag
                for file in $CHANGES_FILES; do
                  echo "Restoring: $file"
                  git checkout "$PREV_VERSION" -- "$file" || echo "Could not restore $file"
                done
              else
                echo "No previous changes files found in $PREV_VERSION"
              fi
            else
              echo "Warning: Previous tag $PREV_VERSION not found"
            fi
          else
            echo "This is the first increment (0), no previous changes to restore"
          fi

      - name: Create prerelease changelog
        run: |
          VERSION="${{ steps.calculate-version.outputs.version }}"
          LABEL="${{ inputs.prerelease-label }}"
          INCREMENT="${{ steps.calculate-increment.outputs.increment }}"

          echo "Creating changelog for prerelease: $VERSION"
          changie batch "$VERSION" --prerelease "${LABEL}-${INCREMENT}" --move-dir=prerelease
          changie merge

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          components: ''
          install-protoc: 'false'

      - name: Update Cargo.lock
        run: |
          echo "Updating Cargo.lock for version ${{ steps.calculate-version.outputs.version }}"
          cargo update --workspace

      - name: Create release artifact
        run: |
          # Create tarball of the prepared release changes
          tar -czf release-changes.tar.gz \
            CHANGELOG.md \
            .changes \
            Cargo.lock \
            pnpm-lock.yaml

      - name: Upload release changes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-changes
          path: release-changes.tar.gz
          retention-days: 1

  build-core-js-sdk:
    name: Build Core JS SDK (NAPI) - ${{ matrix.settings.target }}
    needs: prepare-release
    runs-on: ${{ matrix.settings.host }}
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: macos-latest
            target: x86_64-apple-darwin
          - host: windows-latest
            target: x86_64-pc-windows-msvc
          - host: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - host: macos-latest
            target: aarch64-apple-darwin
          - host: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            use-napi-cross: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.revision }}
          submodules: recursive

      - name: Download release changes
        uses: actions/download-artifact@v4
        with:
          name: release-changes

      - name: Apply release changes
        run: tar -xzf release-changes.tar.gz
        shell: bash

      - name: Build and test NAPI bindings
        uses: ./.github/actions/napi-build-test
        with:
          target: ${{ matrix.settings.target }}
          package-manager: pnpm
          use-napi-cross: ${{ matrix.settings.use-napi-cross && 'true' || 'false' }}
          skip-tests: ${{ contains(matrix.settings.target, 'aarch64') && matrix.settings.host != 'macos-latest' }}

  build-soma:
    name: Build Soma binaries - ${{ matrix.target }}
    needs: prepare-release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: soma
            asset_name: soma-linux-x86_64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact_name: soma
            asset_name: soma-linux-aarch64
            use_cross: true
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: soma
            asset_name: soma-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: soma
            asset_name: soma-macos-aarch64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: soma.exe
            asset_name: soma-windows-x86_64.exe
    env:
      CARGO_INCREMENTAL: 0
      CARGO_PROFILE_TEST_DEBUG: 0
      CARGO_PROFILE_RELEASE_LTO: true
      CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 1
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.revision }}
          submodules: recursive

      - name: Download release changes
        uses: actions/download-artifact@v4
        with:
          name: release-changes

      - name: Apply release changes
        run: tar -xzf release-changes.tar.gz
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          target: ${{ matrix.target }}
          components: ''
          cache: 'false'
          install-protoc: 'true'

      - name: Install cross
        if: matrix.use_cross
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Setup pnpm and Node.js (for frontend build)
        uses: ./.github/actions/setup-pnpm-node
        with:
          install-dependencies: 'true'

      - name: upgrade npm to 11 (supports trusted publishing)
        run: |
          sudo npm install -g npm@latest
          npm -v

      - name: Pre-fetch cargo dependencies
        run: |
          echo "Fetching cargo dependencies to ensure git repos are downloaded..."
          cargo fetch --locked
        shell: bash

      # TODO: might be needed for restate-types build issue on windows
      - name: Fetch git dependency submodules
        run: |
          # Cargo fetches git dependencies to ~/.cargo/git
          # We need to initialize submodules for restate dependency
          CARGO_HOME="${CARGO_HOME:-$HOME/.cargo}"
          RESTATE_DIR=$(find "$CARGO_HOME/git/checkouts" -type d -name "restate-*" 2>/dev/null | head -1)
          if [ -n "$RESTATE_DIR" ] && [ -d "$RESTATE_DIR/.git" ]; then
            echo "Found restate checkout at: $RESTATE_DIR"
            cd "$RESTATE_DIR"
            git submodule update --init --recursive || true
          else
            echo "Warning: Restate git checkout not found after cargo fetch"
            # List what was actually fetched to help debugging
            find "$CARGO_HOME/git/checkouts" -maxdepth 2 -type d 2>/dev/null || true
          fi
        shell: bash

      - name: Build frontend
        run: |
          cd crates/soma/app
          pnpm run build
        shell: bash

      - name: Build binary
        run: |
          if [ "${{ matrix.use_cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }} --bin soma --locked
          else
            cargo build --release --target ${{ matrix.target }} --bin soma --locked
          fi
        shell: bash

      - name: Strip binary (Unix)
        if: matrix.os != 'windows-latest'
        run: strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: soma-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
          retention-days: 1

  # publish-npm:
  #   name: Publish to npm
  #   needs: snapshot-release
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #     id-token: write
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v5
  #       with:
  #         ref: ${{ needs.snapshot-release.outputs.version }}
  #         submodules: recursive

  #     - name: Setup pnpm
  #       uses: pnpm/action-setup@v4
  #       with:
  #         version: 9

  #     - name: upgrade npm to 11 (supports trusted publishing)
  #       run: |
  #         sudo npm install -g npm@latest
  #         npm -v

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: 20
  #         registry-url: 'https://registry.npmjs.org'
  #         cache: 'pnpm'
  #         cache-dependency-path: pnpm-lock.yaml

  #     - name: Setup Rust (for sdk-core build)
  #       uses: ./.github/actions/setup-rust
  #       with:
  #         components: ''

  #     - name: Install dependencies
  #       run: pnpm install --frozen-lockfile

  #     - name: Build packages
  #       run: pnpm -r run build

  #     - name: Publish prerelease to npm
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       run: pnpm -r publish --access public --tag ${{ inputs.prerelease-label }} --no-git-checks

  #     - name: Comment npm package links on release
  #       uses: actions/github-script@v7
  #       env:
  #         RELEASE_TAG: ${{ needs.snapshot-release.outputs.version }}
  #         PRERELEASE_LABEL: ${{ inputs.prerelease-label }}
  #       with:
  #         github-token: ${{ secrets.GITHUB_TOKEN }}
  #         script: |
  #           const tag = process.env.RELEASE_TAG;
  #           const label = process.env.PRERELEASE_LABEL;

  #           // Get all published packages from workspace
  #           const packages = [
  #             '@trysoma/sdk',
  #             '@trysoma/sdk-core',
  #             '@trysoma/api-client'
  #           ];

  #           // Create links to npm packages
  #           const packageLinks = packages.map(pkg => {
  #             const pkgName = pkg.replace('@trysoma/', '');
  #             return `- [${pkg}](https://www.npmjs.com/package/${pkg}/v/${tag.replace('v', '')})`;
  #           }).join('\n');

  #           const comment = `## ðŸ“¦ Published NPM Packages (${label} tag)

  #           ${packageLinks}

  #           Install with:
  #           \`\`\`bash
  #           pnpm add ${packages.map(p => `${p}@${label}`).join(' ')}
  #           \`\`\`
  #           `;

  #           // Find the release by tag
  #           const { data: release } = await github.rest.repos.getReleaseByTag({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             tag: tag
  #           });

  #           // Update the release body
  #           await github.rest.repos.updateRelease({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             release_id: release.id,
  #             body: (release.body || '') + '\n\n' + comment
  #           });

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare-release, build-soma, build-core-js-sdk]
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.revision }}
          fetch-depth: 0
          token: ${{ secrets.TRY_SOMA_BOT_TOKEN }}

      - name: Download release changes
        uses: actions/download-artifact@v4
        with:
          name: release-changes

      - name: Apply release changes
        run: tar -xzf release-changes.tar.gz

      - name: Commit and push release changes
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "chore: prepare release $VERSION" || echo "No changes to commit"
          git push origin ${{ inputs.revision }}

      - name: Create and push tag
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"

          echo "Creating tag: $VERSION"
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"

      - name: Create GitHub Release
        id: create-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare-release.outputs.version }}
          release_name: ${{ needs.prepare-release.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: true

      - name: Download all soma binaries
        uses: actions/download-artifact@v4
        with:
          pattern: soma-*
          path: binaries

      - name: Upload binaries to release
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"

          for target_dir in binaries/soma-*; do
            target=$(basename "$target_dir" | sed 's/^soma-//')
            binary=$(ls "$target_dir")

            # Map target to asset name
            case "$target" in
              x86_64-unknown-linux-gnu)
                asset_name="soma-linux-x86_64"
                ;;
              aarch64-unknown-linux-gnu)
                asset_name="soma-linux-aarch64"
                ;;
              x86_64-apple-darwin)
                asset_name="soma-macos-x86_64"
                ;;
              aarch64-apple-darwin)
                asset_name="soma-macos-aarch64"
                ;;
              x86_64-pc-windows-msvc)
                asset_name="soma-windows-x86_64.exe"
                ;;
              *)
                asset_name="soma-$target"
                ;;
            esac

            echo "Uploading $target_dir/$binary as $asset_name"
            gh release upload "$VERSION" "$target_dir/$binary#$asset_name" --clobber
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  report-failure:
    name: Report Release Failure
    runs-on: ubuntu-latest
    needs: [prepare-release, build-soma, build-core-js-sdk]
    if: failure()
    permissions:
      issues: write
    steps:
      - name: Create issue for failed release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ needs.prepare-release.outputs.version }}';
            const runId = context.runId;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const title = `Release ${version} failed`;
            const body = `## Release Failure

            The snapshot release workflow for version **${version}** has failed.

            **Workflow Run:** ${runUrl}

            ### Failed Jobs

            Please check the workflow run for details on which job(s) failed:
            - prepare-release
            - build-soma
            - build-core-js-sdk

            ### Action Required

            1. Review the failed job logs in the workflow run
            2. Fix any issues identified
            3. Re-run the snapshot release workflow
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['release-failure', 'automated']
            });
