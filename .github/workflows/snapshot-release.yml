name: Snapshot Release

on:
  workflow_dispatch:
    inputs:
      prerelease-label:
        description: 'Prerelease label'
        required: true
        type: choice
        options:
          - snapshot
          - rc
      revision:
        description: 'Branch or tag to release from'
        required: true
        type: string
        default: 'main'
      semantic-version:
        description: 'Semantic version (leave empty to auto-calculate from changie)'
        required: false
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.calculate-version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.revision }}
          fetch-depth: 0
          token: ${{ secrets.TRY_SOMA_BOT_TOKEN }}

      - name: Setup Changie
        uses: miniscruff/changie-action@v2.1.0
        with:
          version: latest

      - name: Get current version
        id: current-version
        run: |
          # Get the current version (latest release tag) before calculating next version
          CURRENT_VERSION=$(git tag -l "v*" | grep -v -E ".*-(snapshot|rc)-" | sort -V | tail -1 || echo "")
          if [ -z "$CURRENT_VERSION" ]; then
            # If no release tags exist, try to get version from changie latest
            CURRENT_VERSION=$(changie latest 2>/dev/null || echo "")
          fi
          echo "Current version: ${CURRENT_VERSION:-none}"
          echo "current_version=${CURRENT_VERSION:-}" >> $GITHUB_OUTPUT

      - name: Calculate base version
        id: base-version
        run: |
          if [ -n "${{ inputs.semantic-version }}" ]; then
            BASE_VERSION="${{ inputs.semantic-version }}"
            if [[ ! "$BASE_VERSION" =~ ^v ]]; then
              BASE_VERSION="v$BASE_VERSION"
            fi
            echo "Using provided version: $BASE_VERSION"
          else
            echo "Calculating next version from changie..."
            BASE_VERSION=$(changie next auto)
            if [ $? -ne 0 ] || [ -z "$BASE_VERSION" ]; then
              echo "Error: Failed to calculate next version from changie"
              exit 1
            fi
            echo "Calculated version: $BASE_VERSION"
          fi
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT

      - name: Calculate prerelease increment
        id: calculate-increment
        run: |
          BASE_VERSION="${{ steps.base-version.outputs.base_version }}"
          LABEL="${{ inputs.prerelease-label }}"

          echo "Finding existing prerelease tags for $BASE_VERSION-$LABEL-*"

          # Get all tags matching the pattern
          EXISTING_TAGS=$(git tag -l "${BASE_VERSION}-${LABEL}-*" | sort -V)

          if [ -z "$EXISTING_TAGS" ]; then
            echo "No existing tags found, starting at 0"
            INCREMENT=0
          else
            echo "Found existing tags:"
            echo "$EXISTING_TAGS"

            # Extract the highest increment number
            HIGHEST=$(echo "$EXISTING_TAGS" | sed "s/${BASE_VERSION}-${LABEL}-//" | sort -n | tail -1)
            INCREMENT=$((HIGHEST + 1))
            echo "Highest increment found: $HIGHEST, using: $INCREMENT"
          fi

          echo "increment=$INCREMENT" >> $GITHUB_OUTPUT

      - name: Calculate full version
        id: calculate-version
        run: |
          BASE_VERSION="${{ steps.base-version.outputs.base_version }}"
          LABEL="${{ inputs.prerelease-label }}"
          INCREMENT="${{ steps.calculate-increment.outputs.increment }}"

          FULL_VERSION="${BASE_VERSION}-${LABEL}-${INCREMENT}"
          echo "Full version: $FULL_VERSION"
          echo "version=$FULL_VERSION" >> $GITHUB_OUTPUT

      - name: Restore previous prerelease changes
        run: |
          BASE_VERSION="${{ steps.base-version.outputs.base_version }}"
          LABEL="${{ inputs.prerelease-label }}"
          INCREMENT="${{ steps.calculate-increment.outputs.increment }}"

          # If this is not the first increment (i > 0), restore previous changes
          if [ "$INCREMENT" -gt 0 ]; then
            PREV_INCREMENT=$((INCREMENT - 1))
            PREV_VERSION="${BASE_VERSION}-${LABEL}-${PREV_INCREMENT}"

            echo "Restoring changes from previous version: $PREV_VERSION"

            # Check if the previous tag exists
            if git rev-parse "$PREV_VERSION" >/dev/null 2>&1; then
              # Get all .changes files from the previous tag
              CHANGES_FILES=$(git ls-tree -r --name-only "$PREV_VERSION" .changes/ | grep -E "\.changes/${BASE_VERSION}-${LABEL}-.*\.md$" || true)

              if [ -n "$CHANGES_FILES" ]; then
                echo "Found previous changes files:"
                echo "$CHANGES_FILES"

                # Restore each file from the previous tag
                for file in $CHANGES_FILES; do
                  echo "Restoring: $file"
                  git checkout "$PREV_VERSION" -- "$file" || echo "Could not restore $file"
                done
              else
                echo "No previous changes files found in $PREV_VERSION"
              fi
            else
              echo "Warning: Previous tag $PREV_VERSION not found"
            fi
          else
            echo "This is the first increment (0), no previous changes to restore"
          fi

      - name: Calculate previous version for comparison
        id: prev-version
        run: |
          BASE_VERSION="${{ steps.base-version.outputs.base_version }}"
          CURRENT_VERSION="${{ steps.current-version.outputs.current_version }}"
          LABEL="${{ inputs.prerelease-label }}"
          INCREMENT="${{ steps.calculate-increment.outputs.increment }}"
          
          PREV_VERSION=""
          
          if [ "$INCREMENT" -gt 0 ]; then
            # For subsequent increments, first try to use the base version tag if it exists
            # (e.g., if v1.0.0 exists, compare v1.0.0-snapshot-5 against v1.0.0)
            if git rev-parse "$BASE_VERSION" >/dev/null 2>&1; then
              PREV_VERSION="$BASE_VERSION"
              echo "Using base version tag for comparison: $PREV_VERSION"
            else
              # Fallback to previous increment if base version tag doesn't exist
              PREV_INCREMENT=$((INCREMENT - 1))
              PREV_VERSION="${BASE_VERSION}-${LABEL}-${PREV_INCREMENT}"
              echo "Base version tag not found, using previous increment: $PREV_VERSION"
            fi
          else
            # For first increment (0), use the current version (previous semantic version)
            # This is the version that exists before creating the snapshot/rc
            if [ -n "$CURRENT_VERSION" ]; then
              PREV_VERSION="$CURRENT_VERSION"
              echo "First increment detected, using current version (previous semantic version) for comparison: $PREV_VERSION"
            else
              echo "Warning: Current version not found, will skip diff generation"
              PREV_VERSION=""
            fi
          fi
          
          # Verify the previous version tag exists
          if [ -n "$PREV_VERSION" ] && ! git rev-parse "$PREV_VERSION" >/dev/null 2>&1; then
            echo "Warning: Previous version tag $PREV_VERSION not found, will skip diff generation"
            PREV_VERSION=""
          fi
          
          echo "prev_version=$PREV_VERSION" >> $GITHUB_OUTPUT
          echo "has_prev_version=$([ -n "$PREV_VERSION" ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

      - name: Install Atlas CLI
        if: steps.prev-version.outputs.has_prev_version == 'true'
        run: |
          curl -sSf https://atlasgo.sh | sh -s -- --community -y
          echo "$HOME/.atlas/bin" >> $GITHUB_PATH

      - name: Download OpenAPI spec from previous version
        if: steps.prev-version.outputs.has_prev_version == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PREV_VERSION="${{ steps.prev-version.outputs.prev_version }}"
          echo "Downloading openapi.json from tag: $PREV_VERSION"
          
          curl -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3.raw" \
                -o ./openapi-prev.json \
                "https://api.github.com/repos/${{ github.repository }}/contents/openapi.json?ref=$PREV_VERSION" || {
            echo "Warning: Could not download openapi.json from $PREV_VERSION, will skip OpenAPI diff"
            touch ./openapi-prev.json
          }

      - name: Check OpenAPI files exist
        if: steps.prev-version.outputs.has_prev_version == 'true'
        id: check-openapi
        run: |
          if [ ! -f ./openapi.json ]; then
            echo "has_current=false" >> $GITHUB_OUTPUT
            echo "Warning: openapi.json not found in current checkout"
          else
            echo "has_current=true" >> $GITHUB_OUTPUT
          fi
          
          if [ ! -f ./openapi-prev.json ] || [ ! -s ./openapi-prev.json ]; then
            echo "has_previous=false" >> $GITHUB_OUTPUT
            echo "Warning: Previous openapi.json not available"
          else
            echo "has_previous=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate OpenAPI diff
        if: |
          steps.prev-version.outputs.has_prev_version == 'true' &&
          steps.check-openapi.outputs.has_current == 'true' &&
          steps.check-openapi.outputs.has_previous == 'true'
        id: openapi-diff
        continue-on-error: true
        uses: oasdiff/oasdiff-action/diff@main
        with:
          base: ./openapi-prev.json
          revision: ./openapi.json

      - name: Run Atlas migrate lint for Soma database
        if: steps.prev-version.outputs.has_prev_version == 'true'
        id: atlas-soma
        continue-on-error: true
        run: |
          PREV_VERSION="${{ steps.prev-version.outputs.prev_version }}"
          echo "Running Atlas migrate lint for Soma database against $PREV_VERSION"
          
          # Fetch the previous version tag
          git fetch origin "refs/tags/$PREV_VERSION:refs/tags/$PREV_VERSION" || git fetch origin "$PREV_VERSION" || true
          
          # Use git-base with the tag name (atlas should handle tags)
          atlas_output=$(atlas migrate lint --env soma --git-base "$PREV_VERSION" 2>&1) || atlas_exit=$?
          if [ -z "$atlas_output" ]; then
            atlas_output="SUCCESS: checksums match, no breaking changes"
          fi
          
          echo "soma_lint_output<<EOF" >> $GITHUB_OUTPUT
          echo "$atlas_output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ -n "${atlas_exit:-}" ]; then
            echo "Atlas lint found issues (exit code: $atlas_exit)"
            echo "$atlas_output"
          fi

      - name: Run Atlas migrate lint for Bridge database
        if: steps.prev-version.outputs.has_prev_version == 'true'
        id: atlas-bridge
        continue-on-error: true
        run: |
          PREV_VERSION="${{ steps.prev-version.outputs.prev_version }}"
          echo "Running Atlas migrate lint for Bridge database against $PREV_VERSION"
          
          # Fetch the previous version tag
          git fetch origin "refs/tags/$PREV_VERSION:refs/tags/$PREV_VERSION" || git fetch origin "$PREV_VERSION" || true
          
          # Use git-base with the tag name (atlas should handle tags)
          atlas_output=$(atlas migrate lint --env bridge --git-base "$PREV_VERSION" 2>&1) || atlas_exit=$?
          if [ -z "$atlas_output" ]; then
            atlas_output="SUCCESS: checksums match, no breaking changes"
          fi
          
          echo "bridge_lint_output<<EOF" >> $GITHUB_OUTPUT
          echo "$atlas_output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ -n "${atlas_exit:-}" ]; then
            echo "Atlas lint found issues (exit code: $atlas_exit)"
            echo "$atlas_output"
          fi

      - name: Prepare environment variables for changie
        id: changie-env
        run: |
          OPENAPI_DIFF=""
          DATABASE_SCHEMA_DIFF=""
          
          if [ "${{ steps.prev-version.outputs.has_prev_version }}" = "true" ]; then
            # Set OpenAPI diff
            if [ "${{ steps.check-openapi.outputs.has_current }}" = "true" ] && [ "${{ steps.check-openapi.outputs.has_previous }}" = "true" ]; then
              OPENAPI_DIFF="${{ steps.openapi-diff.outputs.diff }}"
              if [ -z "$OPENAPI_DIFF" ]; then
                OPENAPI_DIFF="No changes detected in OpenAPI schema."
              fi
            else
              OPENAPI_DIFF="Previous OpenAPI spec not available for comparison."
            fi
            
            # Combine database schema diffs
            SOMA_DIFF="${{ steps.atlas-soma.outputs.soma_lint_output }}"
            BRIDGE_DIFF="${{ steps.atlas-bridge.outputs.bridge_lint_output }}"
            
            if [ -n "$SOMA_DIFF" ] || [ -n "$BRIDGE_DIFF" ]; then
              DATABASE_SCHEMA_DIFF=""
              if [ -n "$SOMA_DIFF" ]; then
                DATABASE_SCHEMA_DIFF="### Soma Database"$'\n'"\`\`\`"$'\n'"$SOMA_DIFF"$'\n'"\`\`\`"
              fi
              if [ -n "$BRIDGE_DIFF" ]; then
                if [ -n "$DATABASE_SCHEMA_DIFF" ]; then
                  DATABASE_SCHEMA_DIFF="$DATABASE_SCHEMA_DIFF"$'\n\n'
                fi
                DATABASE_SCHEMA_DIFF="${DATABASE_SCHEMA_DIFF}### Bridge Database"$'\n'"\`\`\`"$'\n'"$BRIDGE_DIFF"$'\n'"\`\`\`"
              fi
            else
              DATABASE_SCHEMA_DIFF="No database schema changes detected."
            fi
          else
            OPENAPI_DIFF="No previous version found for comparison."
            DATABASE_SCHEMA_DIFF="No previous version found for comparison."
          fi
          
          # Set as environment variables for changie merge (using multiline format)
          echo "OPENAPI_DIFF<<EOF" >> $GITHUB_ENV
          echo -e "$OPENAPI_DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "DATABASE_SCHEMA_DIFF<<EOF" >> $GITHUB_ENV
          echo -e "$DATABASE_SCHEMA_DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "OpenAPI diff prepared (length: ${#OPENAPI_DIFF})"
          echo "Database schema diff prepared (length: ${#DATABASE_SCHEMA_DIFF})"

      - name: Create prerelease changelog
        run: |
          VERSION="${{ steps.calculate-version.outputs.version }}"
          LABEL="${{ inputs.prerelease-label }}"
          INCREMENT="${{ steps.calculate-increment.outputs.increment }}"

          echo "Creating changelog for prerelease: $VERSION"
          changie batch "$VERSION" --prerelease "${LABEL}-${INCREMENT}" --move-dir=prerelease
          changie merge
          cat CHANGELOG.md

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          components: ''
          install-protoc: 'false'

      - name: Update Cargo.lock
        run: |
          echo "Updating Cargo.lock for version ${{ steps.calculate-version.outputs.version }}"
          cargo update --workspace

      - name: Create release artifact
        run: |
          # Capture all modified files (including any Cargo.toml version changes)
          # Use git status to find all modified/new files
          git add -A

          # Create tarball of all changes using --files-from to handle special characters
          git diff --cached --name-only --diff-filter=ACMR > /tmp/changed-files.txt

          # Also add the frontend dist directory (not tracked by git)
          if [ -d "crates/soma/app/dist" ]; then
            echo "Adding frontend dist directory to artifact"
            find crates/soma/app/dist -type f >> /tmp/changed-files.txt
          fi

          if [ -s /tmp/changed-files.txt ]; then
            echo "Packaging changed files:"
            cat /tmp/changed-files.txt
            tar -czf release-changes.tar.gz --files-from=/tmp/changed-files.txt
          else
            echo "No changes detected, creating empty tarball"
            tar -czf release-changes.tar.gz --files-from /dev/null
          fi

      - name: Upload release changes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-changes
          path: release-changes.tar.gz
          retention-days: 1

  build-core-js-sdk:
    name: Build Core JS SDK (NAPI) - ${{ matrix.settings.target }}
    needs: prepare-release
    runs-on: ${{ matrix.settings.host }}
    strategy:
      fail-fast: false
      matrix:
        settings:
          # - host: macos-latest
          #   target: x86_64-apple-darwin
          # - host: windows-latest
          #   target: x86_64-pc-windows-msvc
          # - host: ubuntu-latest
          #   target: x86_64-unknown-linux-gnu
          # - host: macos-latest
          #   target: aarch64-apple-darwin
          - host: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            # Don't use napi-cross - build with native cross-compilation tools
            # use-napi-cross: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.revision }}
          submodules: recursive

      - name: Download release changes
        uses: actions/download-artifact@v4
        with:
          name: release-changes

      - name: Apply release changes
        run: tar -xzf release-changes.tar.gz
        shell: bash

      # - name: Install cross-compilation tools for aarch64-linux
      #   if: matrix.settings.target == 'aarch64-unknown-linux-gnu'
      #   run: |
      #     sudo apt-get update
      #     sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
      #   shell: bash

      # - name: Configure cross-compilation environment
      #   if: matrix.settings.target == 'aarch64-unknown-linux-gnu'
      #   run: |
      #     echo "CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
      #     echo "CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++" >> $GITHUB_ENV
      #     echo "AR_aarch64_unknown_linux_gnu=aarch64-linux-gnu-ar" >> $GITHUB_ENV
      #     echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
      #   shell: bash

      - name: Build and test NAPI bindings
        uses: ./.github/actions/napi-build-test
        with:
          target: ${{ matrix.settings.target }}
          package-manager: pnpm
          # use-napi-cross: ${{ matrix.settings.use-napi-cross && 'true' || 'false' }}
          # skip-tests: ${{ contains(matrix.settings.target, 'aarch64') && matrix.settings.host != 'macos-latest' }}

  # test-macOS-windows-binding:
  #   name: Test bindings on ${{ matrix.settings.target }} - node@${{ matrix.node }}
  #   needs:
  #     - build-core-js-sdk
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       settings:
  #         # - host: windows-latest
  #         #   target: x86_64-pc-windows-msvc
  #         #   architecture: x64
  #         - host: macos-latest
  #           target: aarch64-apple-darwin
  #           architecture: arm64
  #         - host: macos-latest
  #           target: x86_64-apple-darwin
  #           architecture: x64
  #       node:
  #         - '20'
  #         - '22'
  #   runs-on: ${{ matrix.settings.host }}
  #   steps:
  #     - uses: actions/checkout@v5
  #     - name: Setup pnpm and Node.js (for frontend build)
  #       uses: ./.github/actions/setup-pnpm-node
  #       with:
  #         install-dependencies: 'true'
  #         node-version: ${{ matrix.node }}
  #     - name: Install dependencies
  #       run: pnpm install --frozen-lockfile
  #     - name: Download artifacts
  #       uses: actions/download-artifact@v6
  #       with:
  #         name: napi-bindings-${{ matrix.settings.target }}
  #         path: .
  #     - name: List packages
  #       run: ls -R .
  #       shell: bash
  #     - name: Test bindings
  #       working-directory: crates/sdk-js
  #       run: pnpm test

  # test-linux-binding:
  #   name: Test ${{ matrix.target }} - node@${{ matrix.node }}
  #   needs:
  #     - build-core-js-sdk
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       target:
  #         - x86_64-unknown-linux-gnu
  #         # - aarch64-unknown-linux-gnu
  #       node:
  #         - '20'
  #         - '22'
  #   runs-on: ${{ contains(matrix.target, 'aarch64') && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
  #   steps:
  #     - uses: actions/checkout@v5
  #     - name: Setup pnpm and Node.js (for frontend build)
  #       uses: ./.github/actions/setup-pnpm-node
  #       with:
  #         install-dependencies: 'true'
  #         node-version: ${{ matrix.node }}
  #
  #     - name: Output docker params
  #       id: docker
  #       run: |
  #         node -e "
  #           if ('${{ matrix.target }}'.startsWith('aarch64')) {
  #             console.log('PLATFORM=linux/arm64')
  #           } else if ('${{ matrix.target }}'.startsWith('armv7')) {
  #             console.log('PLATFORM=linux/arm/v7')
  #           } else {
  #             console.log('PLATFORM=linux/amd64')
  #           }
  #         " >> $GITHUB_OUTPUT
  #         node -e "
  #           if ('${{ matrix.target }}'.endsWith('-musl')) {
  #             console.log('IMAGE=node:${{ matrix.node }}-alpine')
  #           } else {
  #             console.log('IMAGE=node:${{ matrix.node }}-slim')
  #           }
  #         " >> $GITHUB_OUTPUT
  #     - name: Install dependencies
  #       run: |
  #         pnpm config set supportedArchitectures.cpu '["current", "arm64", "x64", "arm"]'
  #         pnpm config set supportedArchitectures.libc '["current", "musl", "gnu"]'
  #         pnpm install --frozen-lockfile
  #     - name: Download artifacts
  #       uses: actions/download-artifact@v6
  #       with:
  #         name: napi-bindings-${{ matrix.target }}
  #         path: .
  #     - name: List packages
  #       run: ls -R .
  #       shell: bash
  #     - name: Set up QEMU
  #       uses: docker/setup-qemu-action@v3
  #       if: ${{ contains(matrix.target, 'armv7') }}
  #       with:
  #         platforms: all
  #     - run: docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
  #       if: ${{ contains(matrix.target, 'armv7') }}
  #     - name: Test bindings
  #       uses: addnab/docker-run-action@v3
  #       with:
  #         image: ${{ steps.docker.outputs.IMAGE }}
  #         options: '-v ${{ github.workspace }}:${{ github.workspace }} -w ${{ github.workspace }}/crates/sdk-js --platform ${{ steps.docker.outputs.PLATFORM }}'
  #         run: |
  #           corepack enable
  #           corepack prepare pnpm@9 --activate
  #           pnpm config set supportedArchitectures.cpu '["current", "arm64", "x64", "arm"]'
  #           pnpm config set supportedArchitectures.libc '["current", "musl", "gnu"]'
  #           pnpm install --frozen-lockfile
  #           pnpm test

  build-soma:
    name: Build Soma binaries - ${{ matrix.target }}
    needs: prepare-release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # - os: ubuntu-latest
          #   target: x86_64-unknown-linux-gnu
          #   artifact_name: soma
          #   asset_name: soma-linux-x86_64
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            artifact_name: soma
            asset_name: soma-linux-aarch64
          # - os: macos-latest
          #   target: x86_64-apple-darwin
          #   artifact_name: soma
          #   asset_name: soma-macos-x86_64
          # - os: macos-latest
          #   target: aarch64-apple-darwin
          #   artifact_name: soma
          #   asset_name: soma-macos-aarch64
          # - os: windows-latest
          #   target: x86_64-pc-windows-msvc
          #   artifact_name: soma.exe
          #   asset_name: soma-windows-x86_64.exe
    env:
      CARGO_INCREMENTAL: 0
      CARGO_PROFILE_TEST_DEBUG: 0
      CARGO_PROFILE_RELEASE_LTO: true
      CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 1
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.revision }}
          submodules: recursive

      - name: Download release changes
        uses: actions/download-artifact@v4
        with:
          name: release-changes

      - name: Apply release changes
        run: tar -xzf release-changes.tar.gz
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable
          target: ${{ matrix.target }}
          components: ''
          cache: 'true'
          install-protoc: 'true'

      - name: Install cross
        if: matrix.use_cross
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Setup pnpm and Node.js (for frontend build)
        uses: ./.github/actions/setup-pnpm-node
        with:
          install-dependencies: 'true'

      - name: Pre-fetch cargo dependencies
        run: |
          echo "Fetching cargo dependencies to ensure git repos are downloaded..."
          cargo fetch --locked
        shell: bash

      # TODO: might be needed for restate-types build issue on windows
      # - name: Fetch git dependency submodules
      #   run: |
      #     # Cargo fetches git dependencies to ~/.cargo/git
      #     # We need to initialize submodules for restate dependency
      #     CARGO_HOME="${CARGO_HOME:-$HOME/.cargo}"
      #     RESTATE_DIR=$(find "$CARGO_HOME/git/checkouts" -type d -name "restate-*" 2>/dev/null | head -1)
      #     if [ -n "$RESTATE_DIR" ] && [ -d "$RESTATE_DIR/.git" ]; then
      #       echo "Found restate checkout at: $RESTATE_DIR"
      #       cd "$RESTATE_DIR"
      #       git submodule update --init --recursive || true
      #     else
      #       echo "Warning: Restate git checkout not found after cargo fetch"
      #       # List what was actually fetched to help debugging
      #       find "$CARGO_HOME/git/checkouts" -maxdepth 2 -type d 2>/dev/null || true
      #     fi
      #   shell: bash

      - name: Cache frontend build
        uses: actions/cache@v4
        with:
          path: crates/soma/app/dist
          key: frontend-dist-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml', 'crates/soma/app/**/*.ts', 'crates/soma/app/**/*.tsx', 'crates/soma/app/**/*.css', 'crates/soma/app/package.json', 'crates/soma/app/vite.config.ts', 'crates/soma/app/tsconfig.json') }}
          restore-keys: |
            frontend-dist-${{ runner.os }}-

      - name: Build frontend
        run: |
          cd crates/soma/app
          pnpm run build
        shell: bash

      - name: Build binary
        run: |
          if [ "${{ matrix.use_cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }} --bin soma --locked
          else
            cargo build --release --target ${{ matrix.target }} --bin soma --locked
          fi
        shell: bash

      - name: Strip binary (Unix)
        if: matrix.os != 'windows-latest'
        run: strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: soma-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
          retention-days: 1

  # test-soma-macOS-windows:
  #   name: Test Soma binary on ${{ matrix.settings.target }} - ${{ matrix.settings.os }}
  #   needs:
  #     - build-soma
  #   permissions:
  #     contents: read
  #     id-token: write
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       settings:
  #         # - os: windows-latest
  #         #   target: x86_64-pc-windows-msvc
  #         #   artifact_name: soma.exe
  #         - os: macos-latest
  #           target: aarch64-apple-darwin
  #           artifact_name: soma
  #         - os: macos-latest
  #           target: x86_64-apple-darwin
  #           artifact_name: soma
  #   runs-on: ${{ matrix.settings.os }}
  #   env:
  #     CARGO_INCREMENTAL: 0
  #     CARGO_PROFILE_TEST_DEBUG: 0
  #   steps:
  #     - uses: actions/checkout@v5
  #       with:
  #         ref: ${{ inputs.revision }}
  #         submodules: recursive
  #
  #     - name: Download release changes
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: release-changes
  #
  #     - name: Apply release changes
  #       run: tar -xzf release-changes.tar.gz
  #       shell: bash
  #
  #     - name: Configure AWS Credentials for integration tests
  #       uses: aws-actions/configure-aws-credentials@v5.1.0
  #       with:
  #         audience: sts.amazonaws.com
  #         aws-region: eu-west-2
  #         role-to-assume: ${{ secrets.AWS_INTEGRATION_TESTS_ROLE_ARN }}
  #
  #     - name: Setup Rust
  #       uses: ./.github/actions/setup-rust
  #       with:
  #         toolchain: stable
  #         target: ${{ matrix.settings.target }}
  #         components: ''
  #         cache: 'true'
  #         install-protoc: 'true'
  #
  #     - name: Install cargo-nextest
  #       uses: taiki-e/install-action@v2
  #       with:
  #         tool: cargo-nextest
  #
  #     - name: Setup pnpm and Node.js (for frontend build)
  #       uses: ./.github/actions/setup-pnpm-node
  #       with:
  #         install-dependencies: 'true'
  #
  #     - name: Pre-fetch cargo dependencies
  #       run: |
  #         echo "Fetching cargo dependencies to ensure git repos are downloaded..."
  #         cargo fetch --locked
  #       shell: bash
  #
  #     - name: Cache frontend build
  #       uses: actions/cache@v4
  #       with:
  #         path: crates/soma/app/dist
  #         key: frontend-dist-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml', 'crates/soma/app/**/*.ts', 'crates/soma/app/**/*.tsx', 'crates/soma/app/**/*.css', 'crates/soma/app/package.json', 'crates/soma/app/vite.config.ts', 'crates/soma/app/tsconfig.json') }}
  #         restore-keys: |
  #           frontend-dist-${{ runner.os }}-
  #
  #     - name: Build frontend
  #       run: |
  #         cd crates/soma/app
  #         pnpm run build
  #       shell: bash
  #
  #     - name: Download binary artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: soma-${{ matrix.settings.target }}
  #         path: target/${{ matrix.settings.target }}/release
  #
  #     - name: Verify binary exists
  #       run: |
  #         if [ -f "target/${{ matrix.settings.target }}/release/${{ matrix.settings.artifact_name }}" ]; then
  #           echo "Binary found: target/${{ matrix.settings.target }}/release/${{ matrix.settings.artifact_name }}"
  #           ls -lh "target/${{ matrix.settings.target }}/release/${{ matrix.settings.artifact_name }}"
  #         else
  #           echo "Error: Binary not found at target/${{ matrix.settings.target }}/release/${{ matrix.settings.artifact_name }}"
  #           exit 1
  #         fi
  #       shell: bash
  #
  #     - name: Run Rust tests
  #       run: cargo nextest run --target ${{ matrix.settings.target }} --locked
  #       shell: bash

  # test-soma-linux:
  #   name: Test Soma binary on ${{ matrix.target }} - ${{ matrix.os }}
  #   needs:
  #     - build-soma
  #   permissions:
  #     contents: read
  #     id-token: write
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       include:
  #         - os: ubuntu-latest
  #           target: x86_64-unknown-linux-gnu
  #           artifact_name: soma
  #         - os: ubuntu-24.04-arm
  #           target: aarch64-unknown-linux-gnu
  #           artifact_name: soma
  #   runs-on: ${{ matrix.os }}
  #   env:
  #     CARGO_INCREMENTAL: 0
  #     CARGO_PROFILE_TEST_DEBUG: 0
  #   steps:
  #     - uses: actions/checkout@v5
  #       with:
  #         ref: ${{ inputs.revision }}
  #         submodules: recursive
  #
  #     - name: Download release changes
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: release-changes
  #
  #     - name: Apply release changes
  #       run: tar -xzf release-changes.tar.gz
  #       shell: bash
  #
  #     - name: Configure AWS Credentials for integration tests
  #       uses: aws-actions/configure-aws-credentials@v5.1.0
  #       with:
  #         audience: sts.amazonaws.com
  #         aws-region: eu-west-2
  #         role-to-assume: ${{ secrets.AWS_INTEGRATION_TESTS_ROLE_ARN }}
  #
  #     - name: Setup Rust
  #       uses: ./.github/actions/setup-rust
  #       with:
  #         toolchain: stable
  #         target: ${{ matrix.target }}
  #         components: ''
  #         cache: 'true'
  #         install-protoc: 'true'
  #
  #     - name: Install cargo-nextest
  #       uses: taiki-e/install-action@v2
  #       with:
  #         tool: cargo-nextest
  #
  #     - name: Install cross
  #       if: matrix.use_cross
  #       uses: taiki-e/install-action@v2
  #       with:
  #         tool: cross
  #
  #     - name: Setup pnpm and Node.js (for frontend build)
  #       uses: ./.github/actions/setup-pnpm-node
  #       with:
  #         install-dependencies: 'true'
  #
  #     - name: Pre-fetch cargo dependencies
  #       run: |
  #         echo "Fetching cargo dependencies to ensure git repos are downloaded..."
  #         cargo fetch --locked
  #       shell: bash
  #
  #     - name: Cache frontend build
  #       uses: actions/cache@v4
  #       with:
  #         path: crates/soma/app/dist
  #         key: frontend-dist-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml', 'crates/soma/app/**/*.ts', 'crates/soma/app/**/*.tsx', 'crates/soma/app/**/*.css', 'crates/soma/app/package.json', 'crates/soma/app/vite.config.ts', 'crates/soma/app/tsconfig.json') }}
  #         restore-keys: |
  #           frontend-dist-${{ runner.os }}-
  #
  #     - name: Build frontend
  #       run: |
  #         cd crates/soma/app
  #         pnpm run build
  #       shell: bash
  #
  #     - name: Download binary artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: soma-${{ matrix.target }}
  #         path: target/${{ matrix.target }}/release
  #
  #     - name: Verify binary exists
  #       run: |
  #         if [ -f "target/${{ matrix.target }}/release/${{ matrix.artifact_name }}" ]; then
  #           echo "Binary found: target/${{ matrix.target }}/release/${{ matrix.artifact_name }}"
  #           ls -lh "target/${{ matrix.target }}/release/${{ matrix.artifact_name }}"
  #         else
  #           echo "Error: Binary not found at target/${{ matrix.target }}/release/${{ matrix.artifact_name }}"
  #           exit 1
  #         fi
  #       shell: bash
  #
  #     - name: Run Rust tests
  #       run: |
  #         if [ "${{ matrix.use_cross }}" = "true" ]; then
  #           cross test --target ${{ matrix.target }} --locked
  #         else
  #           cargo nextest run --target ${{ matrix.target }} --locked
  #         fi
  #       shell: bash

  publish-npm:
    name: Publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs:
      - build-core-js-sdk
      - build-soma
      # - test-macOS-windows-binding
      # - test-linux-binding
      # - test-soma-macOS-windows
      # - test-soma-linux
    steps:
      - uses: actions/checkout@v5
      
      - name: Download release changes
        uses: actions/download-artifact@v4
        with:
          name: release-changes

      - name: Apply release changes
        run: tar -xzf release-changes.tar.gz
        shell: bash
      
      - name: Setup pnpm and Node.js
        uses: ./.github/actions/setup-pnpm-node
        with:
          install-dependencies: 'true'
          node-version: '22'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: create npm dirs
        working-directory: crates/sdk-js
        run: pnpm napi create-npm-dirs
      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts
      - name: Move artifacts to sdk-js directory
        run: |
          mkdir -p crates/sdk-js/artifacts
          # Move all .node and .wasm files from downloaded artifacts to crates/sdk-js/artifacts
          # Artifacts are downloaded in subdirectories like artifacts/napi-bindings-{target}/
          # Use parentheses to properly group the OR condition in find
          find artifacts \( -name "*.node" -o -name "*.wasm" \) -type f | while read file; do
            cp "$file" crates/sdk-js/artifacts/
          done
          echo "Artifacts moved to crates/sdk-js/artifacts:"
          ls -la crates/sdk-js/artifacts/ || echo "No artifacts found"
          # Verify artifacts exist before proceeding
          if [ ! -d "crates/sdk-js/artifacts" ] || [ -z "$(ls -A crates/sdk-js/artifacts 2>/dev/null)" ]; then
            echo "Error: No artifacts found in crates/sdk-js/artifacts"
            echo "Contents of artifacts directory:"
            find artifacts -type f || echo "No files found"
            echo "Directory structure:"
            find artifacts -type d || echo "No directories found"
            exit 1
          fi
        shell: bash
      - name: Move artifacts
        working-directory: crates/sdk-js
        run: pnpm artifacts
      - name: List packages
        working-directory: crates/sdk-js
        run: ls -R ./npm
        shell: bash
      - name: Verify and update package.json version
        working-directory: crates/sdk-js
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          # Remove 'v' prefix if present for npm version
          NPM_VERSION=$(echo "$VERSION" | sed 's/^v//')
          
          echo "Expected npm version: $NPM_VERSION"
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current package.json version: $CURRENT_VERSION"
          
          if [ "$CURRENT_VERSION" != "$NPM_VERSION" ]; then
            echo "Updating package.json version from $CURRENT_VERSION to $NPM_VERSION"
            # Update package.json version using node
            node -e "const fs = require('fs'); const pkg = require('./package.json'); pkg.version = '$NPM_VERSION'; fs.writeFileSync('package.json', JSON.stringify(pkg, null, '\t') + '\n');"
            echo "Updated package.json version to: $(node -p \"require('./package.json').version\")"
          else
            echo "Package.json version already matches expected version"
          fi


      - name: Setup npm authentication
        run: |
          # Setup npm authentication using NPM_TOKEN secret
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "Error: NPM_TOKEN secret is required for npm publishing"
            exit 1
          fi
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> ~/.npmrc
          echo "Configured npm authentication"

      - name: Publish
        working-directory: crates/sdk-js
        run: |
          # Always publish snapshot/rc releases with the appropriate tag
          VERSION="${{ needs.prepare-release.outputs.version }}"
          LABEL="${{ inputs.prerelease-label }}"
          
          # Use the prerelease label (snapshot or rc) as the npm tag
          npm publish --tag "$LABEL" --access public
          echo "Published version $VERSION with tag '$LABEL'"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare-release, build-soma, build-core-js-sdk, publish-npm]
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.revision }}
          fetch-depth: 0
          token: ${{ secrets.TRY_SOMA_BOT_TOKEN }}

      - name: Download release changes
        uses: actions/download-artifact@v4
        with:
          name: release-changes

      - name: Apply release changes
        run: tar -xzf release-changes.tar.gz

      - name: Create and push tag
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"

          echo "Creating tag: $VERSION"
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"

      - name: Create GitHub Release
        id: create-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare-release.outputs.version }}
          release_name: ${{ needs.prepare-release.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: true

      - name: Download all soma binaries
        uses: actions/download-artifact@v4
        with:
          pattern: soma-*
          path: binaries

      - name: Upload binaries to release
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"

          for target_dir in binaries/soma-*; do
            target=$(basename "$target_dir" | sed 's/^soma-//')
            binary=$(ls "$target_dir")

            # Map target to asset name
            case "$target" in
              x86_64-unknown-linux-gnu)
                asset_name="soma-linux-x86_64"
                ;;
              aarch64-unknown-linux-gnu)
                asset_name="soma-linux-aarch64"
                ;;
              x86_64-apple-darwin)
                asset_name="soma-macos-x86_64"
                ;;
              aarch64-apple-darwin)
                asset_name="soma-macos-aarch64"
                ;;
              x86_64-pc-windows-msvc)
                asset_name="soma-windows-x86_64.exe"
                ;;
              *)
                asset_name="soma-$target"
                ;;
            esac

            echo "Uploading $target_dir/$binary as $asset_name"
            gh release upload "$VERSION" "$target_dir/$binary#$asset_name" --clobber
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment npm package links on release
        uses: actions/github-script@v7
        env:
          RELEASE_TAG: ${{ needs.prepare-release.outputs.version }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = process.env.RELEASE_TAG;
            const version = tag.replace('v', '');

            // Get all published packages from workspace
            const mainPackages = [
              '@trysoma/sdk',
              '@trysoma/sdk-core',
              '@trysoma/api-client'
            ];

            // Platform-specific packages (based on build targets in workflow)
            const platformPackages = [
              '@trysoma/sdk-core-darwin-universal',
              '@trysoma/sdk-core-darwin-x64',
              '@trysoma/sdk-core-darwin-arm64',
              '@trysoma/sdk-core-linux-x64-gnu',
              '@trysoma/sdk-core-linux-arm64-gnu'
            ];

            // Create links to main npm packages
            const mainPackageLinks = mainPackages.map(pkg => {
              return `- [${pkg}](https://www.npmjs.com/package/${pkg}/v/${version})`;
            }).join('\n');

            // Create links to platform-specific packages
            const platformPackageLinks = platformPackages.map(pkg => {
              return `- [${pkg}](https://www.npmjs.com/package/${pkg}/v/${version})`;
            }).join('\n');

            const comment = `## ðŸ“¦ Published NPM Packages

            ### Main Packages
            ${mainPackageLinks}

            ### Platform-Specific Packages
            ${platformPackageLinks}

            Install with:
            \`\`\`bash
            pnpm add ${mainPackages.join(' ')}
            \`\`\`

            > Platform-specific packages are automatically installed as optional dependencies based on your system architecture.
            `;

            // Find the release by tag
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: tag
            });

            // Update the release body
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              body: (release.body || '') + '\n\n' + comment
            });

  report-failure:
    name: Report Release Failure
    runs-on: ubuntu-latest
    needs:
      - prepare-release
      - build-soma
      - build-core-js-sdk
      # - test-macOS-windows-binding
      # - test-linux-binding
      # - test-soma-macOS-windows
      # - test-soma-linux
      - publish-npm
    if: failure()
    permissions:
      issues: write
    steps:
      - name: Create issue for failed release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ needs.prepare-release.outputs.version }}' || 'unknown';
            const runId = context.runId;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            // Determine which jobs failed
            const failedJobs = [];
            if ('${{ needs.prepare-release.result }}' === 'failure') failedJobs.push('prepare-release');
            if ('${{ needs.build-soma.result }}' === 'failure') failedJobs.push('build-soma');
            if ('${{ needs.build-core-js-sdk.result }}' === 'failure') failedJobs.push('build-core-js-sdk');
            // if ('${{ needs.test-macOS-windows-binding.result }}' === 'failure') failedJobs.push('test-macOS-windows-binding');
            // if ('${{ needs.test-linux-binding.result }}' === 'failure') failedJobs.push('test-linux-binding');
            // if ('${{ needs.test-soma-macOS-windows.result }}' === 'failure') failedJobs.push('test-soma-macOS-windows');
            // if ('${{ needs.test-soma-linux.result }}' === 'failure') failedJobs.push('test-soma-linux');
            if ('${{ needs.publish-npm.result }}' === 'failure') failedJobs.push('publish-npm');

            const title = `Release ${version} failed`;
            const body = `## Release Failure

            The snapshot release workflow for version **${version}** has failed.

            **Workflow Run:** ${runUrl}

            ### Failed Jobs

            The following job(s) failed:
            ${failedJobs.map(job => `- ${job}`).join('\n')}

            ### Action Required

            1. Review the failed job logs in the workflow run
            2. Fix any issues identified
            3. Re-run the snapshot release workflow
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['release-failure', 'automated']
            });
