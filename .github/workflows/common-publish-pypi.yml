name: Common - Publish PyPI

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        type: string
    secrets:
      PYPI_API_TOKEN:
        required: true

jobs:
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Download release changes
        uses: actions/download-artifact@v4
        with:
          name: release-changes

      - name: Apply release changes
        run: tar -xzf release-changes.tar.gz
        shell: bash

      - name: Setup uv and Python
        uses: ./.github/actions/setup-uv-python
        with:
          python-version: '3.12'
          install-dependencies: 'false'

      - name: Download all Python wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: py-wheels-*
          path: py-wheels
          merge-multiple: true

      - name: Prepare wheels for upload
        run: |
          mkdir -p dist
          echo "Collecting Python wheels from artifacts..."
          echo "Contents of py-wheels directory:"
          ls -laR py-wheels/ || echo "py-wheels directory is empty or does not exist"

          # Find and copy all wheel files
          find py-wheels -name "*.whl" -type f | while read file; do
            echo "  Copying: $file"
            cp "$file" dist/
          done

          # Find and copy source distribution
          find py-wheels -name "*.tar.gz" -type f | while read file; do
            echo "  Copying: $file"
            cp "$file" dist/
          done

          echo ""
          echo "Wheels ready for upload:"
          ls -la dist/

          # Fail early if no wheels were found
          if [ -z "$(ls -A dist/*.whl 2>/dev/null)" ]; then
            echo "ERROR: No wheel files found in dist directory!"
            echo "This likely means the py-wheels-* artifacts were not uploaded by build-core-py-sdk"
            exit 1
          fi
        shell: bash

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: 'dist/*'

      - name: Publish soma-sdk-core to PyPI
        uses: PyO3/maturin-action@v1
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        with:
          command: upload
          args: --non-interactive --skip-existing dist/*

      - name: Build and publish pure Python packages
        run: |
          VERSION="${{ inputs.version }}"
          VERSION_NUMBER="${VERSION#v}"

          echo "Building and publishing pure Python packages..."

          # Build trysoma-sdk package
          echo "Building trysoma-sdk..."
          uv build --package trysoma-sdk --out-dir py/packages/sdk/dist
          echo "SDK dist contents:"
          ls -la py/packages/sdk/dist/

          # Build trysoma-api-client package
          echo "Building trysoma-api-client..."
          uv build --package trysoma-api-client --out-dir py/packages/api_client/dist
          echo "API client dist contents:"
          ls -la py/packages/api_client/dist/

          # Publish using uv publish (built-in to uv, no twine needed)
          echo "Publishing packages to PyPI..."

          # Publish trysoma-sdk
          uv publish --token "${{ secrets.PYPI_API_TOKEN }}" \
            py/packages/sdk/dist/*

          # Publish trysoma-api-client
          uv publish --token "${{ secrets.PYPI_API_TOKEN }}" \
            py/packages/api_client/dist/*

          echo "âœ“ All Python packages published to PyPI"
        shell: bash

      - name: Verify published packages
        run: |
          VERSION="${{ inputs.version }}"
          VERSION_NUMBER="${VERSION#v}"

          echo "Verifying packages on PyPI..."
          sleep 10  # Wait for PyPI to index

          # Check package availability
          pip index versions trysoma-sdk-core 2>/dev/null | head -5 || echo "trysoma-sdk-core check skipped"
          pip index versions trysoma-sdk 2>/dev/null | head -5 || echo "trysoma-sdk check skipped"
          pip index versions trysoma-api-client 2>/dev/null | head -5 || echo "trysoma-api-client check skipped"
        shell: bash
