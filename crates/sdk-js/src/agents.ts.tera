// Auto-generated A2A Agent Clients
// Do not edit this file manually

import type { ObjectContext } from '@restatedev/restate-sdk';
import { A2AClient } from '@a2a-js/sdk/client';
import type {
  AgentCard,
  MessageSendParams,
  SendMessageResponse,
  TaskQueryParams,
  GetTaskResponse,
  TaskIdParams,
  CancelTaskResponse,
  Message,
  Task,
  TaskStatusUpdateEvent,
  TaskArtifactUpdateEvent
} from '@a2a-js/sdk';

export interface AgentsConfig {
  SOMA_BASE_URL?: string;
}

type A2AStreamEventData = Message | Task | TaskStatusUpdateEvent | TaskArtifactUpdateEvent;

/**
 * Durable A2A client wrapper that makes all A2A operations replayable via Restate.
 * All methods are wrapped with ctx.run() for durability.
 */
export class DurableA2AClient {
  private ctx: ObjectContext;
  private client: A2AClient;
  private agentId: string;

  constructor(ctx: ObjectContext, client: A2AClient, agentId: string) {
    this.ctx = ctx;
    this.client = client;
    this.agentId = agentId;
  }

  /**
   * Send a message to the agent (non-streaming, durable).
   * The entire request/response cycle is wrapped for durability.
   */
  async sendMessage(params: MessageSendParams): Promise<SendMessageResponse> {
    return this.ctx.run(`a2a-${this.agentId}-sendMessage`, async () => {
      return this.client.sendMessage(params);
    });
  }

  /**
   * Send a message and stream responses.
   * Each event from the stream is individually made durable.
   * Returns an async generator that yields events durably.
   */
  async *sendMessageStream(params: MessageSendParams): AsyncGenerator<A2AStreamEventData, void, undefined> {
    // Start the stream (this creates the SSE connection)
    const stream = this.client.sendMessageStream(params);
    let eventIndex = 0;

    for await (const event of stream) {
      // Make each event durable by wrapping it in ctx.run
      const durableEvent = await this.ctx.run(
        `a2a-${this.agentId}-stream-event-${eventIndex}`,
        async () => event
      );
      eventIndex++;
      yield durableEvent;
    }
  }

  /**
   * Get a task by ID (durable).
   */
  async getTask(params: TaskQueryParams): Promise<GetTaskResponse> {
    return this.ctx.run(`a2a-${this.agentId}-getTask-${params.id}`, async () => {
      return this.client.getTask(params);
    });
  }

  /**
   * Cancel a task by ID (durable).
   */
  async cancelTask(params: TaskIdParams): Promise<CancelTaskResponse> {
    return this.ctx.run(`a2a-${this.agentId}-cancelTask-${params.id}`, async () => {
      return this.client.cancelTask(params);
    });
  }

  /**
   * Resubscribe to a task's event stream.
   * Each event from the stream is individually made durable.
   */
  async *resubscribeTask(params: TaskIdParams): AsyncGenerator<A2AStreamEventData, void, undefined> {
    const stream = this.client.resubscribeTask(params);
    let eventIndex = 0;

    for await (const event of stream) {
      const durableEvent = await this.ctx.run(
        `a2a-${this.agentId}-resubscribe-event-${params.id}-${eventIndex}`,
        async () => event
      );
      eventIndex++;
      yield durableEvent;
    }
  }

  /**
   * Get the agent card (durable).
   */
  async getAgentCard(): Promise<AgentCard> {
    return this.ctx.run(`a2a-${this.agentId}-getAgentCard`, async () => {
      return this.client.getAgentCard();
    });
  }
}

{% for agent in agents %}
/**
 * Agent: {{ agent.name }}
 * Project: {{ agent.project_id }}
 * Description: {{ agent.description }}
 */
{% endfor %}

// Agent interface definitions
{% for project in projects %}
export interface {{ project.interface_name }}Agents {
  {% for agent in project.agents %}
  {{ agent.camel_case_id }}: DurableA2AClient;
  {% endfor %}
}
{% endfor %}

export interface Agents {
  {% for project in projects %}
  {{ project.camel_case_id }}: {{ project.interface_name }}Agents;
  {% endfor %}
}

/**
 * Type alias for the agents definition.
 * Use this type when passing agents to pattern handlers.
 */
export type AgentsDefinition = Agents;

/**
 * Get all configured A2A agent clients, wrapped with Restate durability.
 *
 * @param ctx - The Restate ObjectContext for durability
 * @param config - Optional configuration including base URL
 * @returns An object containing all configured agents organized by project
 *
 * @example
 * ```typescript
 * const agents = await getAgents(ctx);
 *
 * // Send a message to an agent
 * const response = await agents.myProject.myAgent.sendMessage({
 *   message: {
 *     role: 'user',
 *     parts: [{ kind: 'text', text: 'Hello!' }],
 *     messageId: 'msg-123',
 *     kind: 'message'
 *   }
 * });
 *
 * // Stream responses from an agent
 * for await (const event of agents.myProject.myAgent.sendMessageStream({
 *   message: { ... }
 * })) {
 *   console.log('Received event:', event);
 * }
 * ```
 */
export async function getAgents(ctx: ObjectContext, config?: AgentsConfig): Promise<Agents> {
  const baseUrl = config?.SOMA_BASE_URL || process.env.SOMA_SERVER_BASE_URL || 'http://localhost:3000';

  // Initialize all A2A clients
  {% for agent in agents %}
  const {{ agent.var_name }}Client = await ctx.run('init-a2a-{{ agent.project_id }}-{{ agent.id }}', async () => {
    const cardUrl = `${baseUrl}/api/agent/{{ agent.project_id }}/{{ agent.id }}/a2a/.well-known/agent.json`;
    return A2AClient.fromCardUrl(cardUrl);
  });
  const {{ agent.var_name }} = new DurableA2AClient(ctx, {{ agent.var_name }}Client, '{{ agent.project_id }}.{{ agent.id }}');
  {% endfor %}

  return {
    {% for project in projects %}
    {{ project.camel_case_id }}: {
      {% for agent in project.agents %}
      {{ agent.camel_case_id }}: {{ agent.var_name }},
      {% endfor %}
    },
    {% endfor %}
  };
}

// Export types for external use
export type {
  AgentCard,
  MessageSendParams,
  SendMessageResponse,
  TaskQueryParams,
  GetTaskResponse,
  TaskIdParams,
  CancelTaskResponse,
  Message,
  Task,
  TaskStatusUpdateEvent,
  TaskArtifactUpdateEvent,
  A2AStreamEventData
};
