syntax = "proto3";

import "google/protobuf/empty.proto";

package soma_sdk_service;

service SomaSdkService {
  rpc Metadata(google.protobuf.Empty) returns (MetadataResponse);
  rpc HealthCheck(google.protobuf.Empty) returns (google.protobuf.Empty);
  rpc InvokeFunction(InvokeFunctionRequest) returns (InvokeFunctionResponse);
  rpc GenerateBridgeClient(GenerateBridgeClientRequest) returns (GenerateBridgeClientResponse);
  rpc SetSecrets(SetSecretsRequest) returns (SetSecretsResponse);
  rpc UnsetSecrets(UnsetSecretRequest) returns (UnsetSecretResponse);
  rpc SetEnvironmentVariables(SetEnvironmentVariablesRequest) returns (SetEnvironmentVariablesResponse);
  rpc UnsetEnvironmentVariables(UnsetEnvironmentVariableRequest) returns (UnsetEnvironmentVariableResponse);
}

message InvokeFunctionRequest {
  string provider_controller_type_id = 1;
  string function_controller_type_id = 2;
  string credential_controller_type_id = 3;
  string credentials = 4;
  string parameters = 5;
}

message InvokeFunctionResponse {
  oneof kind {
    string data = 1;
    CallbackError error = 2;
  }
}

message CallbackError {
  string message = 1;
}

message MetadataResponse {
  repeated ProviderController bridge_providers = 1;
  repeated Agent agents = 2;
}

message ProviderController {
  string type_id = 1;
  string name = 2;
  string documentation = 3;
  repeated string categories = 4;
  repeated FunctionController functions = 5;
  repeated ProviderCredentialController credential_controllers = 6;
}

message Agent {
  string id = 1;
  string project_id = 2;
  string name = 3;
  string description = 4;
}

message ProviderCredentialController {
  oneof kind {
    NoAuth no_auth = 1;
    ApiKey api_key = 2;
    Oauth2AuthorizationCodeFlow oauth2 = 3;
    Oauth2JwtBearerAssertionFlow oauth2_jwt_bearer_assertion_flow = 4;
  }
}

message  Oauth2AuthorizationCodeFlow {
  Oauth2AuthorizationCodeFlowStaticCredentialConfiguration static_credential_configuration = 1;
}

message Oauth2AuthorizationCodeFlowStaticCredentialConfiguration {
    string auth_uri = 1;
    string token_uri = 2;
    string userinfo_uri = 3;
    string jwks_uri = 4;
    string issuer = 5;
    repeated string scopes = 6;
    repeated Metadata metadata = 7;
}

message Metadata {
  string key = 1;
  string value = 2;
}

message Oauth2JwtBearerAssertionFlow {
  Oauth2JwtBearerAssertionFlowStaticCredentialConfiguration static_credential_configuration = 1;
}

message Oauth2JwtBearerAssertionFlowStaticCredentialConfiguration {
  string auth_uri = 1;
  string token_uri = 2;
  string userinfo_uri = 3;
  string jwks_uri = 4;
  string issuer = 5;
  repeated string scopes = 6;
  repeated Metadata metadata = 7;
}

message ApiKey {
}

message NoAuth {}

message FunctionController {
  string name = 1;
  string description = 2;
  string parameters = 3;
  string output = 4;
}

message GenerateBridgeClientRequest {
  repeated FunctionInstanceData function_instances = 1;
}

message GenerateBridgeClientResponse {
  oneof result {
    GenerateBridgeClientSuccess success = 1;
    GenerateBridgeClientError error = 2;
  }
}

message GenerateBridgeClientSuccess {
  string message = 1;
}

message GenerateBridgeClientError {
  string message = 1;
}

message FunctionInstanceData {
  string provider_instance_id = 1;
  string provider_instance_display_name = 2;
  ProviderControllerData provider_controller = 3;
  FunctionControllerData function_controller = 4;
}

message ProviderControllerData {
  string type_id = 1;
  string display_name = 2;
}

message FunctionControllerData {
  string type_id = 1;
  string display_name = 2;
  string params_json_schema = 3;
  string return_value_json_schema = 4;
}

// Secret messages for syncing secrets to the SDK
message Secret {
  string key = 1;
  string value = 2;  // Decrypted value
}

message SetSecretsRequest {
  repeated Secret secrets = 1;
}

message SetSecretsResponse {
  oneof kind {
    CallbackSuccess data = 1;
    CallbackError error = 2;
  }
}

message UnsetSecretRequest {
  string key = 1;
}

message UnsetSecretResponse {
  oneof kind {
    CallbackSuccess data = 1;
    CallbackError error = 2;
  }
}

message CallbackSuccess {
  string message = 1;
}

// Environment variable messages for syncing environment variables to the SDK
message EnvironmentVariable {
  string key = 1;
  string value = 2;
}

message SetEnvironmentVariablesRequest {
  repeated EnvironmentVariable environment_variables = 1;
}

message SetEnvironmentVariablesResponse {
  oneof kind {
    CallbackSuccess data = 1;
    CallbackError error = 2;
  }
}

message UnsetEnvironmentVariableRequest {
  string key = 1;
}

message UnsetEnvironmentVariableResponse {
  oneof kind {
    CallbackSuccess data = 1;
    CallbackError error = 2;
  }
}