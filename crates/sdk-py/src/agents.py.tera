# Auto-generated A2A Agent Clients
# DO NOT EDIT - This file is generated by the Soma SDK

from __future__ import annotations
import os
from typing import TYPE_CHECKING, AsyncGenerator, Any

if TYPE_CHECKING:
    from restate import ObjectContext

# Note: Requires the a2a-sdk package to be installed
# pip install a2a-sdk
from a2a.client import A2AClient
from a2a.types import (
    AgentCard,
    MessageSendParams,
    SendMessageResponse,
    TaskQueryParams,
    GetTaskResponse,
    TaskIdParams,
    CancelTaskResponse,
    Message,
    Task,
    TaskStatusUpdateEvent,
    TaskArtifactUpdateEvent,
)

SOMA_SERVER_BASE_URL = os.environ.get("SOMA_SERVER_BASE_URL", "http://localhost:3000")

# Union type for stream events
A2AStreamEventData = Message | Task | TaskStatusUpdateEvent | TaskArtifactUpdateEvent


class DurableA2AClient:
    """
    Durable A2A client wrapper that makes all A2A operations replayable via Restate.
    All methods are wrapped with ctx.run() for durability.
    """

    def __init__(self, ctx: "ObjectContext", client: A2AClient, agent_id: str):
        self._ctx = ctx
        self._client = client
        self._agent_id = agent_id

    async def send_message(self, params: MessageSendParams) -> SendMessageResponse:
        """
        Send a message to the agent (non-streaming, durable).
        The entire request/response cycle is wrapped for durability.
        """

        async def _send() -> SendMessageResponse:
            return await self._client.send_message(params)

        return await self._ctx.run(f"a2a-{self._agent_id}-send_message", _send)

    async def send_message_stream(
        self, params: MessageSendParams
    ) -> AsyncGenerator[A2AStreamEventData, None]:
        """
        Send a message and stream responses.
        Each event from the stream is individually made durable.
        """
        stream = self._client.send_message_stream(params)
        event_index = 0

        async for event in stream:
            # Make each event durable by wrapping it in ctx.run

            async def _capture_event(evt: A2AStreamEventData = event) -> A2AStreamEventData:
                return evt

            durable_event = await self._ctx.run(
                f"a2a-{self._agent_id}-stream-event-{event_index}", _capture_event
            )
            event_index += 1
            yield durable_event

    async def get_task(self, params: TaskQueryParams) -> GetTaskResponse:
        """Get a task by ID (durable)."""

        async def _get() -> GetTaskResponse:
            return await self._client.get_task(params)

        return await self._ctx.run(f"a2a-{self._agent_id}-get_task-{params.id}", _get)

    async def cancel_task(self, params: TaskIdParams) -> CancelTaskResponse:
        """Cancel a task by ID (durable)."""

        async def _cancel() -> CancelTaskResponse:
            return await self._client.cancel_task(params)

        return await self._ctx.run(
            f"a2a-{self._agent_id}-cancel_task-{params.id}", _cancel
        )

    async def resubscribe_task(
        self, params: TaskIdParams
    ) -> AsyncGenerator[A2AStreamEventData, None]:
        """
        Resubscribe to a task's event stream.
        Each event from the stream is individually made durable.
        """
        stream = self._client.resubscribe_task(params)
        event_index = 0

        async for event in stream:

            async def _capture_event(evt: A2AStreamEventData = event) -> A2AStreamEventData:
                return evt

            durable_event = await self._ctx.run(
                f"a2a-{self._agent_id}-resubscribe-event-{params.id}-{event_index}",
                _capture_event,
            )
            event_index += 1
            yield durable_event

    async def get_agent_card(self) -> AgentCard:
        """Get the agent card (durable)."""

        async def _get_card() -> AgentCard:
            return await self._client.get_agent_card()

        return await self._ctx.run(f"a2a-{self._agent_id}-get_agent_card", _get_card)


{% for agent in agents %}
# Agent: {{ agent.name }}
# Project: {{ agent.project_id }}
# Description: {{ agent.description }}
{% endfor %}

{% for project in projects %}
class {{ project.class_name }}Agents:
    """Agents for project: {{ project.id }}"""

    def __init__(self{% for agent in project.agents %}, {{ agent.snake_case_id }}: DurableA2AClient{% endfor %}):
{% for agent in project.agents %}
        self.{{ agent.snake_case_id }} = {{ agent.snake_case_id }}
{% endfor %}

{% endfor %}

class Agents:
    """Container for all configured A2A agent clients."""

    def __init__(self{% for project in projects %}, {{ project.snake_case_id }}: {{ project.class_name }}Agents{% endfor %}):
{% for project in projects %}
        self.{{ project.snake_case_id }} = {{ project.snake_case_id }}
{% endfor %}


# Type alias for the agents definition.
# Use this type when passing agents to pattern handlers.
AgentsDefinition = Agents


async def get_agents(ctx: "ObjectContext", base_url: str | None = None) -> Agents:
    """
    Get all configured A2A agent clients, wrapped with Restate durability.

    Args:
        ctx: The Restate ObjectContext for durability
        base_url: Optional base URL for the Soma server (defaults to SOMA_SERVER_BASE_URL env var)

    Returns:
        An Agents object containing all configured agents organized by project

    Example:
        ```python
        agents = await get_agents(ctx)

        # Send a message to an agent
        response = await agents.my_project.my_agent.send_message(
            MessageSendParams(
                message=Message(
                    role="user",
                    parts=[TextPart(kind="text", text="Hello!")],
                    message_id="msg-123",
                    kind="message"
                )
            )
        )

        # Stream responses from an agent
        async for event in agents.my_project.my_agent.send_message_stream(params):
            print("Received event:", event)
        ```
    """
    _base_url = base_url or SOMA_SERVER_BASE_URL

    # Initialize all A2A clients
{% for agent in agents %}
    async def _init_{{ agent.var_name }}() -> A2AClient:
        card_url = f"{_base_url}/api/agent/{{ agent.project_id }}/{{ agent.id }}/a2a/.well-known/agent.json"
        return await A2AClient.from_card_url(card_url)

    {{ agent.var_name }}_client = await ctx.run("init-a2a-{{ agent.project_id }}-{{ agent.id }}", _init_{{ agent.var_name }})
    {{ agent.var_name }} = DurableA2AClient(ctx, {{ agent.var_name }}_client, "{{ agent.project_id }}.{{ agent.id }}")
{% endfor %}

    return Agents(
{% for project in projects %}
        {{ project.snake_case_id }}={{ project.class_name }}Agents(
{% for agent in project.agents %}
            {{ agent.snake_case_id }}={{ agent.var_name }},
{% endfor %}
        ),
{% endfor %}
    )


__all__ = [
    "DurableA2AClient",
    "Agents",
    "AgentsDefinition",
{% for project in projects %}
    "{{ project.class_name }}Agents",
{% endfor %}
    "get_agents",
    "AgentCard",
    "MessageSendParams",
    "SendMessageResponse",
    "TaskQueryParams",
    "GetTaskResponse",
    "TaskIdParams",
    "CancelTaskResponse",
    "Message",
    "Task",
    "TaskStatusUpdateEvent",
    "TaskArtifactUpdateEvent",
    "A2AStreamEventData",
]
