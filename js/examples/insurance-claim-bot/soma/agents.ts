// Auto-generated A2A Agent Clients
// Do not edit this file manually

import type {
	AgentCard,
	CancelTaskResponse,
	GetTaskResponse,
	Message,
	MessageSendParams,
	SendMessageResponse,
	Task,
	TaskArtifactUpdateEvent,
	TaskIdParams,
	TaskQueryParams,
	TaskStatusUpdateEvent,
} from "@a2a-js/sdk";
import { A2AClient } from "@a2a-js/sdk/client";
import type { ObjectContext } from "@restatedev/restate-sdk";

export interface AgentsConfig {
	SOMA_BASE_URL?: string;
}

type A2AStreamEventData =
	| Message
	| Task
	| TaskStatusUpdateEvent
	| TaskArtifactUpdateEvent;

/**
 * Durable A2A client wrapper that makes all A2A operations replayable via Restate.
 * All methods are wrapped with ctx.run() for durability.
 */
export class DurableA2AClient {
	private ctx: ObjectContext;
	private client: A2AClient;
	private agentId: string;

	constructor(ctx: ObjectContext, client: A2AClient, agentId: string) {
		this.ctx = ctx;
		this.client = client;
		this.agentId = agentId;
	}

	/**
	 * Send a message to the agent (non-streaming, durable).
	 * The entire request/response cycle is wrapped for durability.
	 */
	async sendMessage(params: MessageSendParams): Promise<SendMessageResponse> {
		return this.ctx.run(`a2a-${this.agentId}-sendMessage`, async () => {
			return this.client.sendMessage(params);
		});
	}

	/**
	 * Send a message and stream responses.
	 * Each event from the stream is individually made durable.
	 * Returns an async generator that yields events durably.
	 */
	async *sendMessageStream(
		params: MessageSendParams,
	): AsyncGenerator<A2AStreamEventData, void, undefined> {
		// Start the stream (this creates the SSE connection)
		const stream = this.client.sendMessageStream(params);
		let eventIndex = 0;

		for await (const event of stream) {
			// Make each event durable by wrapping it in ctx.run
			const durableEvent = await this.ctx.run(
				`a2a-${this.agentId}-stream-event-${eventIndex}`,
				async () => event,
			);
			eventIndex++;
			yield durableEvent;
		}
	}

	/**
	 * Get a task by ID (durable).
	 */
	async getTask(params: TaskQueryParams): Promise<GetTaskResponse> {
		return this.ctx.run(
			`a2a-${this.agentId}-getTask-${params.id}`,
			async () => {
				return this.client.getTask(params);
			},
		);
	}

	/**
	 * Cancel a task by ID (durable).
	 */
	async cancelTask(params: TaskIdParams): Promise<CancelTaskResponse> {
		return this.ctx.run(
			`a2a-${this.agentId}-cancelTask-${params.id}`,
			async () => {
				return this.client.cancelTask(params);
			},
		);
	}

	/**
	 * Resubscribe to a task's event stream.
	 * Each event from the stream is individually made durable.
	 */
	async *resubscribeTask(
		params: TaskIdParams,
	): AsyncGenerator<A2AStreamEventData, void, undefined> {
		const stream = this.client.resubscribeTask(params);
		let eventIndex = 0;

		for await (const event of stream) {
			const durableEvent = await this.ctx.run(
				`a2a-${this.agentId}-resubscribe-event-${params.id}-${eventIndex}`,
				async () => event,
			);
			eventIndex++;
			yield durableEvent;
		}
	}

	/**
	 * Get the agent card (durable).
	 */
	async getAgentCard(): Promise<AgentCard> {
		return this.ctx.run(`a2a-${this.agentId}-getAgentCard`, async () => {
			return this.client.getAgentCard();
		});
	}
}

/**
 * Agent: Insurance Claims Agent
 * Project: acme
 * Description: An agent that can process insurance claims.
 */

/**
 * Agent: Claim Research Agent
 * Project: acme
 * Description: An agent that can research insurance claims.
 */

// Agent interface definitions

export interface AcmeAgents {
	insuranceClaimsAgent: DurableA2AClient;

	claimResearchAgent: DurableA2AClient;
}

export interface Agents {
	acme: AcmeAgents;
}

/**
 * Type alias for the agents definition.
 * Use this type when passing agents to pattern handlers.
 */
export type AgentsDefinition = Agents;

/**
 * Get all configured A2A agent clients, wrapped with Restate durability.
 *
 * @param ctx - The Restate ObjectContext for durability
 * @param config - Optional configuration including base URL
 * @returns An object containing all configured agents organized by project
 *
 * @example
 * ```typescript
 * const agents = await getAgents(ctx);
 *
 * // Send a message to an agent
 * const response = await agents.myProject.myAgent.sendMessage({
 *   message: {
 *     role: 'user',
 *     parts: [{ kind: 'text', text: 'Hello!' }],
 *     messageId: 'msg-123',
 *     kind: 'message'
 *   }
 * });
 *
 * // Stream responses from an agent
 * for await (const event of agents.myProject.myAgent.sendMessageStream({
 *   message: { ... }
 * })) {
 *   console.log('Received event:', event);
 * }
 * ```
 */
export async function getAgents(
	ctx: ObjectContext,
	config?: AgentsConfig,
): Promise<Agents> {
	const baseUrl =
		config?.SOMA_BASE_URL ||
		process.env.SOMA_SERVER_BASE_URL ||
		"http://localhost:3000";

	// Initialize all A2A clients

	const acme_insuranceClaimsAgentClient = await ctx.run(
		"init-a2a-acme-insuranceClaimsAgent",
		async () => {
			const cardUrl = `${baseUrl}/api/agent/acme/insuranceClaimsAgent/a2a/.well-known/agent.json`;
			return A2AClient.fromCardUrl(cardUrl);
		},
	);
	const acme_insuranceClaimsAgent = new DurableA2AClient(
		ctx,
		acme_insuranceClaimsAgentClient,
		"acme.insuranceClaimsAgent",
	);

	const acme_claimResearchAgentClient = await ctx.run(
		"init-a2a-acme-claimResearchAgent",
		async () => {
			const cardUrl = `${baseUrl}/api/agent/acme/claimResearchAgent/a2a/.well-known/agent.json`;
			return A2AClient.fromCardUrl(cardUrl);
		},
	);
	const acme_claimResearchAgent = new DurableA2AClient(
		ctx,
		acme_claimResearchAgentClient,
		"acme.claimResearchAgent",
	);

	return {
		acme: {
			insuranceClaimsAgent: acme_insuranceClaimsAgent,

			claimResearchAgent: acme_claimResearchAgent,
		},
	};
}

// Export types for external use
export type {
	AgentCard,
	MessageSendParams,
	SendMessageResponse,
	TaskQueryParams,
	GetTaskResponse,
	TaskIdParams,
	CancelTaskResponse,
	Message,
	Task,
	TaskStatusUpdateEvent,
	TaskArtifactUpdateEvent,
	A2AStreamEventData,
};
